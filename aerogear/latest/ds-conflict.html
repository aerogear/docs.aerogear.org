<!DOCTYPE html>
<html lang="en">
  <head>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-8+rznmq/k0KZkJlZhnuPEVkbRD7tA0wcFEjY48dajGWn3Xc1MasJwS8/tJ7OEsKW" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-1.9.1.min.js" integrity="sha256-wS9gmOZBqsqWxgIVgA8Y9WcQOa7PgSIX+rPA0VL2rbQ=" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" integrity="sha384-Nud2SriDt2fZ+u85IBC48Yn9p+l4AGlapnX1EGA2KrnZjYJx8sxKnw/CIxc1wU1B" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-url/2.5.3/url.js"></script>
<script>
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	item.on('click', '', content, function(e) {
		$(this).addClass('selected');
		$(this).siblings().removeClass('selected');
		e.data.siblings('.content').addClass('hidden');
		e.data.removeClass('hidden');
	});
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

$(addBlockSwitches);

Zepto(function($){
	if (url('?header') === 'false') {
		// Hide the navbar for showcase apps (#nochrome)
		$('body').addClass('nochrome');
	}
})
</script>


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resolving conflicts in your Data Sync app :: AeroGear Mobile Services</title>
    <link rel="canonical" href="https://docs.aerogear.org/aerogear/latest/ds-conflict.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.png" type="image/x-icon">
  </head>
  <body class="article">
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">AeroGear</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        <li>
          <a href="https://aerogear.org">Home</a>
        </li>

        <li>
          <a href="https://aerogear.org/getting-started/">Getting Started</a>
        </li>

        <li>
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile Services<span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
              <li>
                <a href="https://aerogear.org/services/identity-management/">
                  <i class="material-icons" aria-hidden="true">account_circle</i> Identity Management
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/push/">
                  <i class="material-icons" aria-hidden="true">notifications_active</i> Push Notifications
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/metrics/">
                  <i class="material-icons" aria-hidden="true">insert_chart</i> Mobile Metrics
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/mobile-ci-cd/">
                  <i class="material-icons" aria-hidden="true">build</i> Mobile CI/CD
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/device-security/">
                  <i class="material-icons" aria-hidden="true">security</i> Device Security
                </a>
              </li>
            </ul>
        </li>

        <li>
          <a href="https://aerogear.org/sdks">Mobile SDKs</a>
        </li>

        <li>
         <a href="https://docs.aerogear.org/">Docs</a>
        </li>
   
        <li>
          <a href="https://aerogear.org/community">Community</a>
        </li>
        

        <li>
          <a href="https://aerogear.org/news">News</a>
        </li>
        
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav><div class="main-wrapper">
<div class="navigation-container" data-component="aerogear" data-version="latest">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Mobile Services</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="getting-started.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started-installing.html">Installing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-installing.html#setting-up-aerogear-mobile-services-on-openshift">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-installing.html#provision-mdc">Provisioning Mobile Developer Console</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started-configuring.html">Configuring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-configuring.html#registering">Registering a Mobile App</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-configuring.html#provisioning">Provisioning a Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-configuring.html#binding">Binding Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-configuring.html#configuring">Configuring Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started-running.html">Developing and Running</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-running.html#setting-up-your-local-development-environment">Setting Up Development Environment</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-running.html#running">Running a Mobile App</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="mobile-developer-console.html">Mobile Developer Console</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobile-developer-console.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobile-developer-console.html#provision-mdc">Provisioning Mobile Developer Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="mobile-developer-console.html#registering">Registering a Mobile App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-developer-console.html#sdk">Configure SDK</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobile-developer-console.html#services">Using mobile services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobile-developer-console.html#building">Building Mobile Apps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="con_services.html">Mobile Services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="identity-management.html">Identity Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#setting-up-the-idm-service">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#adding-user-authentication-to-your-mobile-app">User Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#access">Access Control</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#adding-sso-to-your-mobile-app">Single Sign On</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#monitoring">Monitoring Identity Management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="push-notifications.html">Push Notifications</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#setting-up-the-push-service">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#setting-up-the-push-client-app">App configuration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#registering-device">Registering device</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#sending-a-push-notification-push">Sending a Notification</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#handling-push-notifications-push">Handling a Notification</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="mobile-metrics.html">Mobile Metrics</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#setting-up-the-metrics-service">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#analysing-app-usage-metrics">App and Device</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#monitoring-idm-with-metrics">Monitoring IDM Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#monitoring-sync-with-metrics">Monitoring Data Sync Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#viewing-dashboards-metrics">Using Dashboards</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="mobile-cicd.html">Mobile CI/CD</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#setup">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#build-config">Creating a Build Configuration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#jenkins">Adding a Jenkins file</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#building">Building Apps</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#logs">Accessing Build Logs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#deploy">Deploying Apps</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#clean">Cleaning up Builds</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="data-sync.html">Data Sync</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-getting-started.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-query.html">Queries</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-offline.html">Offline</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-realtime.html">Realtime Updates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-auth.html">Authz</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-metrics.html">Metrics</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="ds-conflict.html">Conflict Resolution</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-files.html">File Upload</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-audit.html">Audit Logs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-advanced.html">Advanced Topics</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ds-openshift.html">Running on OpenShift</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="security.html">Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="app-security.html">App Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="app-security.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="app-security.html#setup">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="app-security.html#monitoring">Monitoring App Security</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="device-security.html">Device Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="device-security.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="device-security.html#setup">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="device-security.html#device-trust">Performing Device Trust Checks</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="device-security.html#cert-pinning">Certificate Pinning</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="showcase-apps.html">Showcase Apps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#setup">Service Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#app">Showcase App Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#binding">Service Binding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#downloading-the-mobile-services-configuration-file">Downloading the Mobile Services Configuration File</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#build">Building and Running the Showcase Apps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#certs">Using Self Signed Certs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#features">Demonstrating the Showcase App Features</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="supported_versions.html">Supported Versions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ref_api.html">API Reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="mobile-cli.html">Mobile CLI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="glossary.html">Glossary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Mobile Services</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Mobile Services</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">latest</a>
        </li>
        <li class="version">
          <a href="../v2.0/index.html">v2.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="getting-started.html" class="home-link"></a>
<nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="con_services.html">Mobile Services</a></li>
    <li class="crumb"><a href="data-sync.html">Data Sync</a></li>
    <li class="crumb"><a href="ds-conflict.html">Conflict Resolution</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="versions-menu-toggle" title="Show other versions of page">latest</button>
  <div class="versions-menu">
    <a class="version is-current" href="ds-conflict.html">latest</a>
    <a class="version is-missing" href="../v2.0/index.html">v2.0</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/aerogear/mobile-docs/edit/master/modules/ROOT/pages/ds-conflict.adoc"></a></div>
</div>
<article class="doc">
<h1>Resolving conflicts in your Data Sync app</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#conflict-resolution-{context}">Resolving conflicts on the server</a>
<ul class="sectlevel2">
<li><a href="#resolving-conflicts">Resolving Conflicts</a></li>
<li><a href="#pluggable-conflict-resolution">Pluggable Conflict Resolution</a></li>
<li><a href="#version-based-conflict-resolution">Version Based Conflict Resolution</a></li>
<li><a href="#using-version-based-conflict-resolution">Using Version Based Conflict Resolution</a></li>
<li><a href="#resolving-conflicts-on-the-client">Resolving Conflicts on the Client</a></li>
<li><a href="#resolving-conflicts-on-the-server">Resolving Conflicts on the Server</a></li>
<li><a href="#conflict-resolution-strategies">Conflict Resolution Strategies</a></li>
<li><a href="#conflict-resolution-using-the-reject-function">Conflict Resolution using the <code>reject</code> Function</a></li>
<li><a href="#custom-conflict-resolution-strategies">Custom Conflict Resolution Strategies</a></li>
<li><a href="#implementing-custom-conflict-mechanism">Implementing Custom Conflict Mechanism</a></li>
</ul>
</li>
<li><a href="#resolving-conflicts-on-the-client-2">Resolving conflicts on the client</a>
<ul class="sectlevel2">
<li><a href="#version-based-conflict-detection">Version Based Conflict Detection</a></li>
<li><a href="#conflict-resolution-strategies-2">Conflict Resolution Strategies</a></li>
<li><a href="#listening-to-conflicts">Listening to Conflicts</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="conflict-resolution-{context}"><a class="anchor" href="#conflict-resolution-{context}"></a>Resolving conflicts on the server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Applications that allow users to modify data while offline most likely have to deal with conflicts.
A <strong>conflict</strong> occurs whenever two or more clients try to modify the same data in between synchronizations.</p>
</div>
<div class="paragraph">
<p><strong>Example:</strong> A user tried to modify a record while they were offline. When they came back online, they discovered that the record was already deleted.</p>
</div>
<div class="paragraph">
<p><strong>Conflict resolution</strong> is how the application handles the conflict and ensures the correct data is stored. In most cases, the way conflicts are detected and resolved are incredibly specific to an application and the underlying data storage.</p>
</div>
<div class="paragraph">
<p>In a GraphQL server, conflict detection and resolution happens exclusively in <strong>mutations</strong>.</p>
</div>
<div class="sect2">
<h3 id="resolving-conflicts"><a class="anchor" href="#resolving-conflicts"></a>Resolving Conflicts</h3>
<div class="paragraph">
<p>At a high level, there is a typical flow to detecting and resolving conflicts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>A Mutation Occurs</strong> - A client tries to modify or delete an object on the server using a GraphQL mutation.</p>
</li>
<li>
<p><strong>Read the Object</strong> - The server reads the current object the client is trying to modify from the data source (usually a database).</p>
</li>
<li>
<p><strong>Conflict Detection</strong> - The server compares the current object with the data sent by the client to see if there was a conflict. The developer can choose <em>how the comparison</em> is done.</p>
</li>
<li>
<p><strong>Conflict Resolution</strong> - Conflict resolution can be deferred to the client or it can be done on the server. The developer can choose the resolution strategy.</p>
</li>
<li>
<p><strong>Persist the Data</strong> - Conflict Resolution on the server results in a new object which should be persisted.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>aerogear/voyager-conflicts</code> module uses the concept of <strong>pluggable conflict resolution</strong> to help developers with the <strong>Conflict Detection</strong> and <strong>Conflict Resolution</strong> steps.</p>
</div>
</div>
<div class="sect2">
<h3 id="pluggable-conflict-resolution"><a class="anchor" href="#pluggable-conflict-resolution"></a>Pluggable Conflict Resolution</h3>
<div class="paragraph">
<p>Pluggable conflict resolution is a concept that allows developers to define their own logic for <strong>conflict detection</strong> and <strong>conflict resolution</strong>, regardless of the data storage.</p>
</div>
<div class="paragraph">
<p>It has two parts: one for detecting conflicts, and the other for resolving conflicts.</p>
</div>
<div class="paragraph">
<p>To detect conflicts, developers can use either the default version-based conflict detection mechanism, or provide their own implementation via the <code>conflictStateProvider</code> option in the config object that is used to initialize the sync client.</p>
</div>
<div class="paragraph">
<p>To resolve conflicts, developers can either use the default conflict resolution strategy, or provide their own ones via the <code>conflictStrategy</code> option in the config object.</p>
</div>
<div class="paragraph">
<p>The conflict detection and resolution is enabled by Voyager Server, while the fetching and storing of data is the responsibility of the developer.</p>
</div>
<div class="paragraph">
<p>Pluggable conflict resolution supports the following implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VersionedObjectState</code> - depends on version field supplied in objects (used by default when importing conflictHandler)</p>
</li>
<li>
<p><code>HashObjectState</code> - depends on hash calculated from entire object</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementations are based on the <code>ObjectState</code> interface that can be extended to provide custom implementation for conflict detection.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>GraphQL server with resolvers.</p>
</li>
<li>
<p>Database or any other form of data storage that can cause data conflicts.
AeroGear recommends that you store data in a secure location.
If you use a database, it is your responsibility to administer, maintain and backup that database.
If you use any other form of data storage, you are responsible for backing up the data.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="version-based-conflict-resolution"><a class="anchor" href="#version-based-conflict-resolution"></a>Version Based Conflict Resolution</h3>
<div class="paragraph">
<p>Version based conflict resolution is the recommended and simplest approach for conflict detection and resolution.
The core idea is that every object has a <code>version</code> property with an integer value. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  title: "Buy some milk"
  version: 1
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a client tries to update object, they must send along their last known version number along with the changes to the server.
The server updates the version, persists the changes and sends back the new object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  title: "Buy some bread"
  version: 2
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <strong>conflict</strong> occurs when the version number sent by the client does not match the version stored in the server. This means a different client already updated the object.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-version-based-conflict-resolution"><a class="anchor" href="#using-version-based-conflict-resolution"></a>Using Version Based Conflict Resolution</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Import the <a href="https://npmjs.com/package/@aerogear/voyager-conflicts">@aerogear/voyager-conflicts</a> package.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { conflictHandler } = require('@aerogear/voyager-conflicts')</code></pre>
</div>
</div>
</li>
<li>
<p>Add a version field to the GraphQL type that should support conflict resolution. The version should also be stored in the data storage.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">type Task {
  title: String
  version: Int
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add an example mutation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">type Mutation {
  updateTask(title: String!, version: Int!): Task
}</code></pre>
</div>
</div>
</li>
<li>
<p>Implement the resolver.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Conflicts can be resolved either on the client or the server. Depending on the strategy used, the resolver implementation will differ.
See the sections below for the individual implementations.</p>
</div>
</div>
<div class="sect2">
<h3 id="resolving-conflicts-on-the-client"><a class="anchor" href="#resolving-conflicts-on-the-client"></a>Resolving Conflicts on the Client</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  updateTask: async (obj, clientData, context, info) =&gt; {
    // 1. Read the Object from the database. This example uses Knex https://knexjs.org/.
    const task = await context.db('tasks').select().where('id', clientData.id).then((rows) =&gt; rows[0])

    // 2. Conflict Detection using `VersionedObjectState`
    //    If the version number from the database does not match the one sent by the client
    //    A conflict occurs
    if (conflictHandler.hasConflict(task, clientData)) {
      // If a conflict is detected, choose to resolve on the client.
      const { response } = conflictHandler.resolveOnClient(task, clientData)
      return response
    }

    // 3. Always call nextState before persisting the updated record.
    // This ensures it has the correct version number
    conflictHandler.nextState(clientData)

    // 4. Persist the update to the database
    const update = await context.db('tasks')
      .update(clientData)
      .where('id', clientData.id)
      .returning('*')
      .then((rows) =&gt; rows[0])

    return update
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, <code>conflictHandler.resolveOnClient</code> is used when a conflict is detected. <code>resolveOnClient</code> returns a <code>response</code> object which should be returned to the client. The <code>response</code> contains the conflicting data and some metadata which the client can use to resolve the conflict.</p>
</div>
<div class="paragraph">
<p>Since the conflict will be resolved on the client, it is not required to persist the data. However, if there is no conflict, the data sent by the client should be persisted.</p>
</div>
</div>
<div class="sect2">
<h3 id="resolving-conflicts-on-the-server"><a class="anchor" href="#resolving-conflicts-on-the-server"></a>Resolving Conflicts on the Server</h3>
<div class="paragraph">
<p><code>conflictHandler.resolveOnServer</code> is used to resolve conflicts on the server side. <code>resolveOnServer</code> accepts a <code>ConfictResolutionStrategy</code> function as its first argument. The example below uses one of the default conflict resolution strategies from the <code>@aerogear/voyager-conflicts</code> module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { conflictHandler, strategies } = require('@aerogear/voyager-conflicts')</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript"> {
   updateTask: async (obj, clientData, context, info) =&gt; {
     // 1. Read the Object from the database. This example uses Knex https://knexjs.org/.
     const task = await context.db('tasks').select().where('id', clientData.id).then((rows) =&gt; rows[0])

     // 2. Conflict Detection using `VersionedObjectState`
     //    If the version number from the database does not match the one sent by the client
     //    A conflict occurs
     if (conflictHandler.hasConflict(task, clientData)) {
       // If a conflict is detected, resolve it on the server using one of the default strategies.
       const { resolvedState, response } = await conflictHandler.resolveOnServer(strategies.clientWins, task, clientData)

       // persist the resolved data to the database and then return the conflict response
       await context.db('tasks')
         .update(resolvedState)
         .where('id', resolvedState.id)
         .returning('*')
         .then((rows) =&gt; rows[0])

       return response
     }

     // 3. Always call nextState before persisting the updated record.
     // This ensures it has the correct version number
     conflictHandler.nextState(clientData)

     // 4. Persist the update to the database and return it to the client
     const update = await context.db('tasks')
       .update(clientData)
       .where('id', clientData.id)
       .returning('*')
       .then((rows) =&gt; rows[0])

     return update
   }
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>When there is no conflict, <code>conflictHandler.nextState(clientData)</code> is called and the data is persisted. When a conflict occurs, the following happens.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>conflictHandler.resolveOnServer</code> is called with the <code>clientWins</code> strategy. In this case, the <code>resolvedState</code> will be the new data provided by the client. The newly <code>resolvedState</code> should be persisted.</p>
</li>
<li>
<p><code>conflictHandler.resolveOnServer</code> also returns a <code>response</code>, which should be returned to the client.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>response</code> object is a <code>ConflictResolution</code> object that tells the client there was a conflict, that it was resolved on the server and provides the new <code>resolvedState</code>. In most cases, the client needs to know about conflicts that happen on the server. This allows the client to handle the conflict accordingly. For example, the screen the user is looking at might need to be refreshed with new data after a conflict.</p>
</div>
</div>
<div class="sect2">
<h3 id="conflict-resolution-strategies"><a class="anchor" href="#conflict-resolution-strategies"></a>Conflict Resolution Strategies</h3>
<div class="paragraph">
<p>There is one default conflict resolution strategy.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>clientWins</code> - This strategy accepts the data provided by the client.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="conflict-resolution-using-the-reject-function"><a class="anchor" href="#conflict-resolution-using-the-reject-function"></a>Conflict Resolution using the <code>reject</code> Function</h3>
<div class="paragraph">
<p>It is possible to implement a 'server wins' style strategy using the <code>reject</code> method. This is useful in conflict cases where we want to reject the client&#8217;s changes and force the client to use the latest data stored on the sever.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// If a conflict is detected, call the reject function
// to keep the server side data and force the client to update
if (conflictHandler.hasConflict(serverData, clientData)) {
  return conflictHandler.reject(task, clientData)
}
// otherwise continue and perform the standard mutation logic</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="custom-conflict-resolution-strategies"><a class="anchor" href="#custom-conflict-resolution-strategies"></a>Custom Conflict Resolution Strategies</h3>
<div class="paragraph">
<p>In most real world cases, the conflict resolution strategies used by your application are custom and specific to your application&#8217;s needs. Your application may deal with different conflicts in different ways. It is possible to implement a custom <code>ConflictResolutionStrategy</code> function to be used with <code>resolveOnServer</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function customResolutionStrategy (serverState, clientState) {
  return {
    title: `${serverState.title} ${clientState.title}`
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example takes string values from the server and the client records, merges them together and returns the newly resolved object. This example is a little contrived but it shows how any strategy could be implemented.</p>
</div>
<div class="paragraph">
<p>Use the custom strategy in your resolvers the same way as the previous examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">if (conflictHandler.hasConflict(serverData, clientData)) {
  // If a conflict is detected, resolve it on the server using the custom strategy.
  const { resolvedState, response } = conflictHandler.resolveOnServer(customResolutionStrategy, serverData, clientData)
  // persist the resolved data to the database and then return the conflict response
  await persistToDatabase(resolvedState)
  return response
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom <code>ConflictResolutionStrategy</code> function can also be <code>async</code> or return a <code>Promise</code> if you need to do some asynchronous operations as part of your strategy (e.g. call to an external service).</p>
</div>
</div>
<div class="sect2">
<h3 id="implementing-custom-conflict-mechanism"><a class="anchor" href="#implementing-custom-conflict-mechanism"></a>Implementing Custom Conflict Mechanism</h3>
<div class="paragraph">
<p>The <code>ObjectState</code> interface is a complete conflict resolution implementation that provides a set of rules to detect and handle conflict. Interface will allow developers to handle conflict on the client or the server. <code>nextState</code> method is a way for interface to modify existing object before is being saved to the database.
For example when using <code>lastModified</code> field as a way to detect conflicts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">public nextState(currentObjectState: ObjectStateData) {
  currentObjectState.lastModified = new Date()
  return currentObjectState
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resolving-conflicts-on-the-client-2"><a class="anchor" href="#resolving-conflicts-on-the-client-2"></a>Resolving conflicts on the client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <strong>conflict</strong> occurs whenever two or more clients try to modify the same data in between synchronizations.</p>
</div>
<div class="paragraph">
<p><strong>Conflict resolution</strong> is how the application detects and resolves the conflict and ensures the correct data is stored. In most cases, the way conflicts are detected and resolved are incredibly specific to an application and the underlying data storage.</p>
</div>
<div class="paragraph">
<p>The Data Sync SDK provides some utilities to help applications detect and resolve conflicts on either server or client side. To handle conflicts on client side, developers need to configure their resolvers on the server side to return conflicts back to clients first. For more information, see the <a href="#sync-server-offline-and-conflict">Voyager server document</a>.</p>
</div>
<div class="paragraph">
<p>If conflicts need to be handled on client side, developers can either use the default conflict resolution implementations, or implement their own ones thanks to the pluggable conflict resolution mechanism.</p>
</div>
<div class="sect2">
<h3 id="version-based-conflict-detection"><a class="anchor" href="#version-based-conflict-detection"></a>Version Based Conflict Detection</h3>
<div class="paragraph">
<p>For more details about how it works, see the <em>server-version-based-conflict-resolution, Voyager server document</em>.</p>
</div>
<div class="paragraph">
<p>On the client side, if this default implementation is used, developers need to make sure the version value is always passed to the server when a mutation is invoked.</p>
</div>
</div>
<div class="sect2">
<h3 id="conflict-resolution-strategies-2"><a class="anchor" href="#conflict-resolution-strategies-2"></a>Conflict Resolution Strategies</h3>
<div class="paragraph">
<p>To resolve conflicts on the client side, a <code>conflictStrategy</code> needs to be provided. If none is provided, by default, the <code>clientVersionWins</code> strategy is used. This means the SDK will automatically override the server data with the current client data.</p>
</div>
<div class="paragraph">
<p>To implement a custom conflict resolution strategy provide at least one of the parameters below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>strategies - a dictionary object where each key is the name of a mutation and the value is the custom action for a conflict caused by that mutation</p>
</li>
<li>
<p>default - the default behavior to use if one of your mutations is not listed in <code>strategies</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If strategies are provided but no default then <code>clientVersionWins</code> becomes the default.
If a mutation causes a conflict and you have not specified a conflict resolution strategy for that mutation, the system uses the <code>clientVersionWins</code> strategy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">//define a custom conflict resolver
let updateTaskConflictResolver = (serverData, clientData) =&gt; {
    ...
    return Object.assign(serverData, clientData);
};

let deleteTaskConflictResolver = (serverData, clientData) =&gt; {
    ...
    return serverData;
}

//define a default where the clientData is used
let defaultConflictResolver = (serverData, clientData) =&gt; {
    return clientData
}

//pass it to the config object
let config = {
...
  conflictStrategy: {
    strategies: {
      "TaskUpdated": updateTaskConflictResolver,
      "TaskDeleted": deleteTaskConflictResolver
    },
    default: defaultConflictResolver
  }
...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Client strategy is ignored when conflicts are resolved on the server.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="listening-to-conflicts"><a class="anchor" href="#listening-to-conflicts"></a>Listening to Conflicts</h3>
<div class="paragraph">
<p>Developers can supply their own <code>conflictListener</code> implementation to get notifications about conflicts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">let config = {
...
  conflictListener: {
    conflictOccurred: function(operationName, resolvedData, server, client) {
      console.log(`data: ${JSON.stringify(resolvedData)}, server: ${JSON.stringify(server)} client: ${JSON.stringify(client)} `);
    }
  }
...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <div class="container">
    <div class="row">

      <div class="col-sm-4">
        <h5>Mobile Services</h5>
        <ul class="list-unstyled">
         <li><a href="https://aerogear.org/services/identity-management/">Identity Management</a></li>
         <li><a href="https://aerogear.org/services/push/">Push Notifications</a></li>
         <li><a href="https://aerogear.org/services/metrics/">Mobile Metrics</a></li>
         <li><a href="https://aerogear.org/services/mobile-ci-cd/">Mobile CI/CD</a></li>
         <li><a href="https://aerogear.org/services/device-security/">Device Security</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-4">
        <h5>Mobile SDKs</h5>
        <ul class="list-unstyled">
         <li><a href="https://aerogear.org/sdks/android/">Android</a></li>
         <li><a href="https://aerogear.org/sdks/cordova/">Cordova</li>
         <li><a href="https://aerogear.org/sdks/ios/">iOS</a></li>
         <li><a href="https://aerogear.org/sdks/xamarin/">Xamarin</a></li>
        </ul>
      </div><!-- col -->
      
      <div class="col-sm-4">
        <h5>COMMUNITY</h5>
        <ul class="list-unstyled">
          <li><a target="_blank" href="https://github.com/aerogear/">GitHub - Aerogear</a></li>
          <li><a target="_blank" href="https://github.com/aerogearcatalog/">GitHub - Aerogear Catalog</a></li>
          <li><a target="_blank" href="https://issues.jboss.org/browse/AEROGEAR">Jira Repo Issues</a></li>
          <li><a  href="https://aerogear.org/community/contribution-guide/">Contribution Guide</a></li>
          <li><a target="_blank" href="https://groups.google.com/forum/#!forum/aerogear">Google Group</a></li>
          <li><a href="irc://irc.freenode.net/aerogear">IRC</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-12 follow">
        <h5>FOLLOW US</h5>
        <ul class="list-inline">
          <li><a target="_blank" href="https://www.twitter.com/aerogears"><i class="fa fa-twitter-square"></i> Twitter</a></li>
          <li><a target="_blank" href="https://www.youtube.com/channel/UCgDcDoN2b7cEI63fgpxACBA"><i class="fa fa-youtube"></i> YouTube</a></li>
          <li><a target="_blank" href="https://aerogear.org/news"><i class="fa fa-rss-square"></i> Feed</a></li>
        </ul>
        
        <p>The AeroGear project is licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>, and is subject to the <a href="https://aerogear.org/legal/export.html">Export Policy</a>.</p>
      </div><!-- col -->
    
    </div><!-- row -->

  </div><!-- container -->

</footer><!-- footer -->

<section class="redhat">
  <div class="container">
    <p class="text-center">
      <a href="http://www.redhat.com/">
        <img src="/_/img/redhatlogo-wite.png" alt="redhatlogo-wite" width="130">
      </a>
    </p>       
  </div><!-- container -->
</section>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
