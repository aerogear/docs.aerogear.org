<!DOCTYPE html>
<html lang="en">
  <head>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-8+rznmq/k0KZkJlZhnuPEVkbRD7tA0wcFEjY48dajGWn3Xc1MasJwS8/tJ7OEsKW" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-1.9.1.min.js" integrity="sha256-wS9gmOZBqsqWxgIVgA8Y9WcQOa7PgSIX+rPA0VL2rbQ=" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" integrity="sha384-Nud2SriDt2fZ+u85IBC48Yn9p+l4AGlapnX1EGA2KrnZjYJx8sxKnw/CIxc1wU1B" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-url/2.5.3/url.js"></script>
<script>
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	item.on('click', '', content, function(e) {
		$(this).addClass('selected');
		$(this).siblings().removeClass('selected');
		e.data.siblings('.content').addClass('hidden');
		e.data.removeClass('hidden');
	});
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

$(addBlockSwitches);

Zepto(function($){
	if (url('?header') === 'false') {
		// Hide the navbar for showcase apps (#nochrome)
		$('body').addClass('nochrome');
	}
})
</script>


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developing a Data Sync Application :: AeroGear Mobile Services</title>
    <link rel="canonical" href="https://docs.aerogear.org/aerogear/latest/data-sync.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.png" type="image/x-icon">
  </head>
  <body class="article">
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">AeroGear</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        <li>
          <a href="https://aerogear.org">Home</a>
        </li>

        <li>
          <a href="https://aerogear.org/getting-started/">Getting Started</a>
        </li>

        <li>
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile Services<span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
              <li>
                <a href="https://aerogear.org/services/identity-management/">
                  <i class="material-icons" aria-hidden="true">account_circle</i> Identity Management
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/push/">
                  <i class="material-icons" aria-hidden="true">notifications_active</i> Push Notifications
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/metrics/">
                  <i class="material-icons" aria-hidden="true">insert_chart</i> Mobile Metrics
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/mobile-ci-cd/">
                  <i class="material-icons" aria-hidden="true">build</i> Mobile CI/CD
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/device-security/">
                  <i class="material-icons" aria-hidden="true">security</i> Device Security
                </a>
              </li>
            </ul>
        </li>

        <li>
          <a href="https://aerogear.org/sdks">Mobile SDKs</a>
        </li>

        <li>
         <a href="https://docs.aerogear.org/">Docs</a>
        </li>
   
        <li>
          <a href="https://aerogear.org/community">Community</a>
        </li>
        

        <li>
          <a href="https://aerogear.org/news">News</a>
        </li>
        
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav><div class="main-wrapper">
<div class="navigation-container" data-component="aerogear" data-version="v2.0">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Mobile Services</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="getting-started.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started-installing.html">Installing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-installing.html#setting-up-aerogear-mobile-services-on-openshift">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-installing.html#provision-mdc">Provisioning Mobile Developer Console</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started-configuring.html">Configuring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-configuring.html#registering">Registering a Mobile App</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-configuring.html#provisioning">Provisioning a Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-configuring.html#binding">Binding Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started-running.html">Developing and Running</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-running.html#setting-up-your-local-development-environment">Setting Up Development Environment</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="getting-started-running.html#running">Running a Mobile App</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="mobile-developer-console.html">Mobile Developer Console</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobile-developer-console.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobile-developer-console.html#provision-mdc">Provisioning Mobile Developer Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="mobile-developer-console.html#registering">Registering a Mobile App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-developer-console.html#sdk">Configure SDK</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobile-developer-console.html#services">Using mobile services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobile-developer-console.html#building">Building Mobile Apps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="con_services.html">Mobile Services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="identity-management.html">Identity Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#setting-up-the-idm-service">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#adding-user-authentication-to-your-mobile-app">User Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#access">Access Control</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#adding-sso-to-your-mobile-app">Single Sign On</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="identity-management.html#monitoring">Monitoring Identity Management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="push-notifications.html">Push Notifications</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#setting-up-the-push-service">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#setting-up-the-push-client-app">App configuration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#registering-device">Registering device</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#sending-a-push-notification-push">Sending a Notification</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="push-notifications.html#handling-push-notifications-push">Handling a Notification</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="mobile-metrics.html">Mobile Metrics</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#setting-up-the-metrics-service">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#analysing-app-usage-metrics">App and Device</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#monitoring-idm-with-metrics">Monitoring IDM Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#monitoring-sync-with-metrics">Monitoring Data Sync Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-metrics.html#viewing-dashboards-metrics">Using Dashboards</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="mobile-cicd.html">Mobile CI/CD</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#setup">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#build-config">Creating a Build Configuration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#jenkins">Adding a Jenkins file</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#building">Building Apps</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#logs">Accessing Build Logs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#deploy">Deploying Apps</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mobile-cicd.html#clean">Cleaning up Builds</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="data-sync.html">Data Sync</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#sync-server">Voyager Server</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-getting-started">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-offline-and-conflict">Offline and Conflicts</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-data-access">Data Access</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-realtime-updates">Realtime Updates</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-auth">Authentication and Authorization</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#server-files">File Upload</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-metrics">Metrics</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-audit-logs">Audit Logs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#sync-js-client">Voyager Client</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-js-basic-concepts">Introduction</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-js-client-getting-started">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-js-client-offline-and-conflict">Offline and Conflicts</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-js-client-realtime-updates">Realtime Updates</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-js-client-auth">Authentication and Authorization</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#js-client-files">File Upload</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-js-client-audit-logs">Audit Logs</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-js-client-advanced-topics">Advanced Topics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#sync-server-openshift">Running Data Sync in OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-getting-started-openshift">Overview</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#building-and-publishing-the-container">Prepare Container</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#provisioning-data-sync-service">Provisioning Overview</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#provisioning-data-sync-templates">Provisioning From Templates</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-getting-started-mdc-client">Configuring Mobile App</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-binding">Binding Mobile App</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#sync-server-binding-keycloak">Binding KeyCloak</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="device-security.html">Device Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="device-security.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="device-security.html#setup">Setting Up</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="device-security.html#device-trust">Performing Device Trust Checks</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="device-security.html#cert-pinning">Certificate Pinning</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="showcase-apps.html">Showcase Apps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#setup">Service Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#app">Showcase App Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#binding">Service Binding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#downloading-the-mobile-services-configuration-file">Downloading the Mobile Services Configuration File</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#build">Building and Running the Showcase Apps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#certs">Using Self Signed Certs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="showcase-apps.html#features">Demonstrating the Showcase App Features</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="supported_versions.html">Supported Versions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ref_api.html">API Reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="mobile-cli.html">Mobile CLI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="glossary.html">Glossary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Mobile Services</span>
    <span class="version">v2.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Mobile Services</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../latest/index.html">latest</a>
        </li>
        <li class="version is-current">
          <a href="index.html">v2.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../latest/getting-started.html" class="home-link"></a>
<nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="con_services.html">Mobile Services</a></li>
    <li class="crumb"><a href="data-sync.html">Data Sync</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="versions-menu-toggle" title="Show other versions of page">v2.0</button>
  <div class="versions-menu">
    <a class="version" href="../latest/data-sync.html">latest</a>
    <a class="version is-current" href="data-sync.html">v2.0</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/aerogear/mobile-docs/edit/v2.0/modules/ROOT/pages/data-sync.adoc"></a></div>
</div>
<article class="doc">
<h1>Developing a Data Sync Application</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel2">
<li><a href="#ref_terminology_sync">Data Sync Terminology</a></li>
<li><a href="#sync-server">Data Sync Server</a>
<ul class="sectlevel2">
<li><a href="#getting-started-with-hello-world-sync">Getting Started with Hello World Data Sync</a></li>
<li><a href="#conflict-resolution-sync">Conflict Resolution</a></li>
<li><a href="#accessing-data-sync">Accessing Data</a></li>
<li><a href="#realtime-updates-sync">Realtime Updates</a></li>
<li><a href="#authentication-and-authorization-sync">Authentication and Authorization using Keycloak</a></li>
<li><a href="#server-files">Enabling file uploads</a></li>
<li><a href="#metrics-and-logging">Metrics and Logging</a></li>
</ul>
</li>
<li><a href="#sync-js-client">Data Sync Javascript Client</a>
<ul class="sectlevel2">
<li><a href="#sync-js-basic-concepts">Introduction</a></li>
<li><a href="#sync-js-client-offline-and-conflict">Supporting offline operations</a></li>
<li><a href="#sync-js-client-realtime-updates">Implementing realtime updates</a></li>
<li><a href="#sync-js-client-auth">Authentication and Authorization</a></li>
<li><a href="#js-client-files">File Upload Client</a></li>
<li><a href="#uploading-files-from-graphql">Uploading Files from GraphQL</a></li>
<li><a href="#sync-js-client-audit-logs">Audit Logs</a></li>
<li><a href="#sync-js-client-advanced-topics">Advanced Topics</a></li>
</ul>
</li>
<li><a href="#sync-server-openshift">Running Data Sync on OpenShift</a>
<ul class="sectlevel2">
<li><a href="#overview-2">Overview</a></li>
<li><a href="#building-and-publishing-the-container">Building and publishing the Data Sync server container</a></li>
<li><a href="#sync-server-provisioning-data-sync">Provisioning the Data Sync server application as a service</a></li>
<li><a href="#sync-server-provisioning-data-sync-templates">Provisioning the Data Sync server applications using templates</a></li>
<li><a href="#sync-server-getting-started-mdc-client">Connecting a Client</a></li>
<li><a href="#sync-server-binding">Binding a Mobile App with the Data Sync server application service</a></li>
<li><a href="#sync-server-binding-keycloak">Binding Data Sync to Identity Management</a></li>
</ul>
</li>
<li><a href="#sync-sample-app">Showcase App</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div id="introduction" class="paragraph">
<p>Data Sync is a JavaScript framework that enables a developer add real time synchronization and enhanced offline capabilities to mobile applications.</p>
</div>
<div class="paragraph">
<p>Data Sync includes two components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sync Server is a set of Node.js libraries that can be used to build a custom backend Data Sync service using GraphQL.</p>
</li>
<li>
<p>Sync Client is a client side JavaScript library for building web and mobile applications backed by Sync Server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Features include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Real Time Synchronisation</p>
</li>
<li>
<p>Conflict Resolution</p>
</li>
<li>
<p>Robust offline experience</p>
</li>
<li>
<p>Authentication and Authorization (using the Identity Management service)</p>
</li>
<li>
<p>Metrics (using the  Mobile Metrics Service)</p>
</li>
<li>
<p>Audit Logging</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unlike other mobile services which provide a server and an API, Data Sync is a framework that you use to develop services. Typically, you develop a Data Sync service as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Design a <a href="https://graphql.org/learn">GraphQL</a> schema.</p>
</li>
<li>
<p>Develop a server side service.</p>
</li>
<li>
<p>Containerize your server and deploy it to OpenShift as a Data Sync App.</p>
</li>
<li>
<p>Bind your mobile app to that data sync server app.</p>
</li>
<li>
<p>Configure your mobile app to point to the data sync server app.</p>
</li>
<li>
<p>Complete your mobile app development.</p>
</li>
<li>
<p>Build and run your mobile app.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ref_terminology_sync"><a class="anchor" href="#ref_terminology_sync"></a>Data Sync Terminology</h3>
<div class="paragraph">
<p>This section describes terminology that is associated with Data Sync.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">GraphQL</dt>
<dd>
<p>A query language for your API, and a server-side runtime for executing queries by using a type system you define for your data. An alternative approach to REST for building APIs and applications. See <a href="https://graphql.org/learn">GraphQL</a>.</p>
</dd>
<dt class="hdlist1">Apollo</dt>
<dd>
<p>Apollo is an implementation of GraphQL designed for the needs of product engineering teams building modern, data-driven applications. Apollo includes two open-source libraries, Apollo Server and Apollo Client. See <a href="https://www.apollographql.com">Apollo</a>.</p>
</dd>
<dt class="hdlist1">Apollo Server</dt>
<dd>
<p>Apollo Server is a library for building GraphQL APIs in Node.js. A developer defines a GraphQL schema and a set of resolvers to implement each part of the schema. See <a href="https://www.apollographql.com/docs/apollo-server">Apollo Server</a>.</p>
</dd>
<dt class="hdlist1">Apollo Client</dt>
<dd>
<p>Apollo Client is a JavaScript client library for building web and mobile applications powered by a GraphQL API. See <a href="https://www.apollographql.com/docs/react">Apollo Client</a>.</p>
</dd>
</dl>
</div>
<div id="sync_additional-resources-sync" class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://graphql.org/learn">Learn GraphQL</a></p>
</li>
<li>
<p><a href="https://github.com/aerogear/voyager-server">Voyager Server GitHub repository</a></p>
</li>
<li>
<p><a href="https://github.com/aerogear/aerogear-js-sdk/tree/master/packages/sync">Voyager Client GitHub repository</a></p>
</li>
<li>
<p><a href="https://www.apollographql.com/docs/apollo-server">Apollo Server</a></p>
</li>
<li>
<p><a href="https://www.apollographql.com/docs/react">Apollo Client</a></p>
</li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="sync-server"><a class="anchor" href="#sync-server"></a>Data Sync Server</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="getting-started-with-hello-world-sync"><a class="anchor" href="#getting-started-with-hello-world-sync"></a>Getting Started with Hello World Data Sync</h3>
<div class="paragraph">
<p>Sync Server is a set of Node.js libraries that can be used to build a custom backend Data Sync service using GraphQL.</p>
</div>
<div class="paragraph">
<p>Sync Server is the starting point for developing a Data Sync application. Used with <a href="https://expressjs.com/">Express</a>, this module leverages Apollo Server and provides extension points for additional features and integrations.</p>
</div>
<div class="paragraph">
<p>In this example, you add libraries to your node.js project, create an <code>index.js</code> file, run the server, and confirm that it works.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have Node.js and npm installed.</p>
</li>
<li>
<p>You have created a node.js project.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add libraries to your Node.js application:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ npm install graphql <i class="conum" data-value="1"></i><b>(1)</b>
$ npm install express <i class="conum" data-value="2"></i><b>(2)</b>
$ npm install @aerogear/voyager-server <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>See <a href="https://graphql.org/" class="bare">https://graphql.org/</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>See <a href="https://expressjs.com/" class="bare">https://expressjs.com/</a></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The Sync Server library that enables data sync</td>
</tr>
</table>
</div>
</div>
</div>
</li>
<li>
<p>Create an <code>index.js</code> file with the following content:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const express = require('express')
//Include our server libraries
const { VoyagerServer, gql } = require('@aerogear/voyager-server')

//Provide your graphql schema
const typeDefs = gql`
  type Query {
    hello: String
  }
`

//Create the resolvers for your schema
const resolvers = {
  Query: {
    hello: (obj, args, context, info) =&gt; {
      return `Hello world`
    }
  }
}

//Initialize the library with your Graphql information
const server = VoyagerServer({
  typeDefs,
  resolvers
})

//Connect the server to express
const app = express()
server.applyMiddleware({ app })

app.listen(4000, () =&gt;
  console.log(`🚀 Server ready at http://localhost:4000/graphql`)
)</code></pre>
</div>
</div>
</li>
<li>
<p>Run the server:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ node index.js

🚀 Server ready at http://localhost:4000/graphql</code></pre>
</div>
</div>
</li>
<li>
<p>Browse <code><a href="http://localhost:4000/graphql" class="bare">http://localhost:4000/graphql</a></code> and interact with the playground. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  hello
}</code></pre>
</div>
</div>
</li>
<li>
<p>Check the output. For the example above, the output should be:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  "data": {
    "hello": "Hello world"
  }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>To get started with the  Data Sync framework, see the <a href="https://github.com/aerogear/ionic-showcase">sample application</a>.
In this app, you can explore a more complex schema.</p>
</div>
<div class="paragraph">
<p>Before proceeding, make sure you have an understanding of the following GraphQL concepts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Schema design</p>
</li>
<li>
<p>Resolvers</p>
</li>
<li>
<p>Subscriptions</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="conflict-resolution-sync"><a class="anchor" href="#conflict-resolution-sync"></a>Conflict Resolution</h3>
<div class="paragraph">
<p>Applications that allow users to modify data while offline most likely have to deal with conflicts.
A <strong>conflict</strong> occurs whenever two or more clients try to modify the same data in between synchronizations.</p>
</div>
<div class="paragraph">
<p><strong>Example:</strong> A user tried to modify a record while they were offline. When they came back online, they discovered that the record was already deleted.</p>
</div>
<div class="paragraph">
<p><strong>Conflict resolution</strong> is how the application handles the conflict and ensures the correct data is stored. In most cases, the way conflicts are detected and resolved are incredibly specific to an application and the underlying data storage.</p>
</div>
<div class="paragraph">
<p>In a GraphQL server, conflict detection and resolution happens exclusively in <strong>mutations</strong>.</p>
</div>
<div class="sect3">
<h4 id="resolving-conflicts"><a class="anchor" href="#resolving-conflicts"></a>Resolving Conflicts</h4>
<div class="paragraph">
<p>At a high level, there is a typical flow to detecting and resolving conflicts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>A Mutation Occurs</strong> - A client tries to modify or delete an object on the server using a GraphQL mutation.</p>
</li>
<li>
<p><strong>Read the Object</strong> - The server reads the current object the client is trying to modify from the data source (usually a database).</p>
</li>
<li>
<p><strong>Conflict Detection</strong> - The server compares the current object with the data sent by the client to see if there was a conflict. The developer can choose <em>how the comparison</em> is done.</p>
</li>
<li>
<p><strong>Conflict Resolution</strong> - Conflict resolution can be deferred to the client or it can be done on the server. The developer can choose the resolution strategy.</p>
</li>
<li>
<p><strong>Persist the Data</strong> - Conflict Resolution on the server results in a new object which should be persisted.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>aerogear/voyager-conflicts</code> module uses the concept of <strong>pluggable conflict resolution</strong> to help developers with the <strong>Conflict Detection</strong> and <strong>Conflict Resolution</strong> steps.</p>
</div>
</div>
<div class="sect3">
<h4 id="pluggable-conflict-resolution"><a class="anchor" href="#pluggable-conflict-resolution"></a>Pluggable Conflict Resolution</h4>
<div class="paragraph">
<p>Pluggable conflict resolution is a concept that allows developers to define their own logic for <strong>conflict detection</strong> and <strong>conflict resolution</strong>, regardless of the data storage.</p>
</div>
<div class="paragraph">
<p>The conflict detection and resolution is enabled by Sync Server, while the fetching and storing of data is the responsibility of the developer.</p>
</div>
<div class="paragraph">
<p>Pluggable conflict resolution supports the following implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VersionedObjectState</code> - depends on version field supplied in objects (used by default when importing conflictHandler)</p>
</li>
<li>
<p><code>HashObjectState</code> - depends on hash calculated from entire object</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementations are based on the <code>ObjectState</code> interface that can be extended to provide custom implementation for conflict detection.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>GraphQL server with resolvers.</p>
</li>
<li>
<p>Database or any other form of data storage that can cause data conflicts.
AeroGear recommends that you store data in a secure location.
If you use a database, it is your responsibility to administer, maintain and backup that database.
If you use any other form of data storage, you are responsible for backing up the data.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="version-based-conflict-resolution"><a class="anchor" href="#version-based-conflict-resolution"></a>Version Based Conflict Resolution</h4>
<div class="paragraph">
<p>Version based conflict resolution is the recommended and simplest approach for conflict detection and resolution.
The core idea is that every object has a <code>version</code> property with an integer value. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  title: "Buy some milk"
  version: 1
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a client tries to update object, they must send along their last known version number along with the changes to the server.
The server updates the version, persists the changes and sends back the new object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  title: "Buy some bread"
  version: 2
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <strong>conflict</strong> occurs when the version number sent by the client does not match the version stored in the server. This means a different client already updated the object.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-version-based-conflict-resolution"><a class="anchor" href="#using-version-based-conflict-resolution"></a>Using Version Based Conflict Resolution</h4>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Import the <a href="https://npmjs.com/package/@aerogear/voyager-conflicts">@aerogear/voyager-conflicts</a> package.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { conflictHandler } = require('@aerogear/voyager-conflicts')</code></pre>
</div>
</div>
</li>
<li>
<p>Add a version field to the GraphQL type that should support conflict resolution. The version should also be stored in the data storage.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">type Task {
  title: String
  version: Int
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add an example mutation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">type Mutation {
  updateTask(title: String!, version: Int!): Task
}</code></pre>
</div>
</div>
</li>
<li>
<p>Implement the resolver.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Conflicts can be resolved either on the client or the server. Depending on the strategy used, the resolver implementation will differ.
See the sections below for the individual implementations.</p>
</div>
</div>
<div class="sect3">
<h4 id="resolving-conflicts-on-the-client"><a class="anchor" href="#resolving-conflicts-on-the-client"></a>Resolving Conflicts on the Client</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  updateTask: async (obj, clientData, context, info) =&gt; {
    // 1. Read the Object from the database. This example uses Knex https://knexjs.org/.
    const task = await context.db('tasks').select().where('id', clientData.id).then((rows) =&gt; rows[0])

    // 2. Conflict Detection using `VersionedObjectState`
    //    If the version number from the database does not match the one sent by the client
    //    A conflict occurs
    if (conflictHandler.hasConflict(task, clientData)) {
      // If a conflict is detected, choose to resolve on the client.
      const { response } = conflictHandler.resolveOnClient(task, clientData)
      return response
    }

    // 3. Always call nextState before persisting the updated record.
    // This ensures it has the correct version number
    conflictHandler.nextState(clientData)

    // 4. Persist the update to the database
    const update = await context.db('tasks')
      .update(clientData)
      .where('id', clientData.id)
      .returning('*')
      .then((rows) =&gt; rows[0])

    return update
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, <code>conflictHandler.resolveOnClient</code> is used when a conflict is detected. <code>resolveOnClient</code> returns a <code>response</code> object which should be returned to the client. The <code>response</code> contains the conflicting data and some metadata which the client can use to resolve the conflict.</p>
</div>
<div class="paragraph">
<p>Since the conflict will be resolved on the client, it is not required to persist the data. However, if there is no conflict, the data sent by the client should be persisted.</p>
</div>
</div>
<div class="sect3">
<h4 id="resolving-conflicts-on-the-server"><a class="anchor" href="#resolving-conflicts-on-the-server"></a>Resolving Conflicts on the Server</h4>
<div class="paragraph">
<p><code>conflictHandler.resolveOnServer</code> is used to resolve conflicts on the server side. <code>resolveOnServer</code> accepts a <code>ConfictResolutionStrategy</code> function as its first argument. The example below uses one of the default conflict resolution strategies from the <code>@aerogear/voyager-conflicts</code> module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { conflictHandler, strategies } = require('@aerogear/voyager-conflicts')</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript"> {
   updateTask: async (obj, clientData, context, info) =&gt; {
     // 1. Read the Object from the database. This example uses Knex https://knexjs.org/.
     const task = await context.db('tasks').select().where('id', clientData.id).then((rows) =&gt; rows[0])

     // 2. Conflict Detection using `VersionedObjectState`
     //    If the version number from the database does not match the one sent by the client
     //    A conflict occurs
     if (conflictHandler.hasConflict(task, clientData)) {
       // If a conflict is detected, resolve it on the server using one of the default strategies.
       const { resolvedState, response } = await conflictHandler.resolveOnServer(strategies.clientWins, task, clientData)

       // persist the resolved data to the database and then return the conflict response
       await context.db('tasks')
         .update(resolvedState)
         .where('id', resolvedState.id)
         .returning('*')
         .then((rows) =&gt; rows[0])

       return response
     }

     // 3. Always call nextState before persisting the updated record.
     // This ensures it has the correct version number
     conflictHandler.nextState(clientData)

     // 4. Persist the update to the database and return it to the client
     const update = await context.db('tasks')
       .update(clientData)
       .where('id', clientData.id)
       .returning('*')
       .then((rows) =&gt; rows[0])

     return update
   }
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>When there is no conflict, <code>conflictHandler.nextState(clientData)</code> is called and the data is persisted. When a conflict occurs, the following happens.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>conflictHandler.resolveOnServer</code> is called with the <code>clientWins</code> strategy. In this case, the <code>resolvedState</code> will be the new data provided by the client. The newly <code>resolvedState</code> should be persisted.</p>
</li>
<li>
<p><code>conflictHandler.resolveOnServer</code> also returns a <code>response</code>, which should be returned to the client.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>response</code> object is a <code>ConflictResolution</code> object that tells the client there was a conflict, that it was resolved on the server and provides the new <code>resolvedState</code>. In most cases, the client needs to know about conflicts that happen on the server. This allows the client to handle the conflict accordingly. For example, the screen the user is looking at might need to be refreshed with new data after a conflict.</p>
</div>
</div>
<div class="sect3">
<h4 id="conflict-resolution-strategies"><a class="anchor" href="#conflict-resolution-strategies"></a>Conflict Resolution Strategies</h4>
<div class="paragraph">
<p>There is one default conflict resolution strategy.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>clientWins</code> - This strategy accepts the data provided by the client.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="conflict-resolution-using-the-reject-function"><a class="anchor" href="#conflict-resolution-using-the-reject-function"></a>Conflict Resolution using the <code>reject</code> Function</h4>
<div class="paragraph">
<p>It is possible to implement a 'server wins' style strategy using the <code>reject</code> method. This is useful in conflict cases where we want to reject the client&#8217;s changes and force the client to use the latest data stored on the sever.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// If a conflict is detected, call the reject function
// to keep the server side data and force the client to update
if (conflictHandler.hasConflict(serverData, clientData)) {
  return conflictHandler.reject(task, clientData)
}
// otherwise continue and perform the standard mutation logic</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="custom-conflict-resolution-strategies"><a class="anchor" href="#custom-conflict-resolution-strategies"></a>Custom Conflict Resolution Strategies</h4>
<div class="paragraph">
<p>In most real world cases, the conflict resolution strategies used by your application are custom and specific to your application&#8217;s needs. Your application may deal with different conflicts in different ways. It is possible to implement a custom <code>ConflictResolutionStrategy</code> function to be used with <code>resolveOnServer</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function customResolutionStrategy (serverState, clientState) {
  return {
    title: `${serverState.title} ${clientState.title}`
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example takes string values from the server and the client records, merges them together and returns the newly resolved object. This example is a little contrived but it shows how any strategy could be implemented.</p>
</div>
<div class="paragraph">
<p>Use the custom strategy in your resolvers the same way as the previous examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">if (conflictHandler.hasConflict(serverData, clientData)) {
  // If a conflict is detected, resolve it on the server using the custom strategy.
  const { resolvedState, response } = conflictHandler.resolveOnServer(customResolutionStrategy, serverData, clientData)
  // persist the resolved data to the database and then return the conflict response
  await persistToDatabase(resolvedState)
  return response
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom <code>ConflictResolutionStrategy</code> function can also be <code>async</code> or return a <code>Promise</code> if you need to do some asynchronous operations as part of your strategy (e.g. call to an external service).</p>
</div>
</div>
<div class="sect3">
<h4 id="implementing-custom-conflict-mechanism"><a class="anchor" href="#implementing-custom-conflict-mechanism"></a>Implementing Custom Conflict Mechanism</h4>
<div class="paragraph">
<p>The <code>ObjectState</code> interface is a complete conflict resolution implementation that provides a set of rules to detect and handle conflict. Interface will allow developers to handle conflict on the client or the server. <code>nextState</code> method is a way for interface to modify existing object before is being saved to the database.
For example when using <code>lastModified</code> field as a way to detect conflicts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">public nextState(currentObjectState: ObjectStateData) {
  currentObjectState.lastModified = new Date()
  return currentObjectState
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="accessing-data-sync"><a class="anchor" href="#accessing-data-sync"></a>Accessing Data</h3>
<div class="paragraph">
<p>Typically, a Data Sync application accesses a database.
The GraphQL specification and Sync Server modules do not require an application to use a particular type of database, and the developer of the application can choose a database that is most suitable for the application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
AeroGear recommends that you store data in a secure location.
If you use a database, it is your responsibility to administer, maintain and backup that database.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The GraphQL specification and Sync Server modules not require an application to use a particular type of database, and the developer of the application can choose a database that is most suitable for the application.</p>
</div>
<div class="paragraph">
<p>From a high level, this section describes the steps to access data from a database in a Data Sync application:</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Initialize the database connection on app start.</p>
</li>
<li>
<p>Add the database connection to the <code>context</code> object.</p>
</li>
<li>
<p>Retrieve/persist data to the database in the application&#8217;s resolvers.</p>
</li>
<li>
<p>Initialize the database connection</p>
<div class="paragraph">
<p>AeroGear recommends that the database connection is set up on application start, and fail if the connection can not be established.
In order to connect to the database, usually the information like the hostname and port number of the database server, the credentials to authenticate are required.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
AeroGear recommends that you use environment variables to set up the database connection.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the application is going to be deployed on OpenShift as described in <a href="#Running your Data Sync application on OpenShift">[Running your Data Sync application on OpenShift]</a>, then the following environment variables will be setup for the application automatically:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Environment Variable Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Server Hostname</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB_HOSTNAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Server Port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Server Username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB_USERNAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Server Password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB_PASSWORD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use SSL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB_SSL</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, if an application needs to connect to a PostgreSQL database (where all tables and schemas are already set up) then a database connection can be established on app start as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">//knex is a SQL query builder
const knex = require('knex')

const config = {
  database: process.env.DB_NAME || 'users',
  user: process.env.DB_USERNAME || 'postgresql',
  password: process.env.DB_PASSWORD || 'postgres',
  host: process.env.DB_HOSTNAME || '127.0.0.1',
  port: process.env.DB_PORT || '5432'
}

const db = knex({
  client: 'pg',
  connection: config
})</code></pre>
</div>
</div>
</li>
<li>
<p>Add the database connection to the <code>context</code> object so that a resolver can access the database.</p>
<div class="paragraph">
<p>From a very high level, the <code>context</code> object is an object shared by all resolvers in a particular query, and is used to contain per-request state, including authentication information, dataloader instances, and anything else that should be taken into account when resolving the query.</p>
</div>
<div class="paragraph">
<p>For more information, see the <a href="https://www.apollographql.com/docs/apollo-server/essentials/data.html#context">the Apollo documentation for the context argument</a>.</p>
</div>
<div class="paragraph">
<p>The database connection can be added to the <code>context</code> object from the previous example as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const typeDefs = //define the schema
const resolvers = //define the resolvers

const apolloConfig = {
  typeDefs,
  resolvers,
  context: {
    db: db.client
  }
}

const voyagerConfig = {...} //other config for the Voyager server
const apolloServer = VoyagerServer(apolloConfig, voyagerConfig)</code></pre>
</div>
</div>
</li>
<li>
<p>Use the database connection in resolvers</p>
<div class="paragraph">
<p>Once the database connection is available in the <code>context</code> object, it can be used in resolvers to retrieve/persist data.</p>
</div>
<div class="paragraph">
<p>Using the previous example, the schema for the application is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">type Task {
  id: ID!
  version: Int
  title: String!
  description: String!
}

type Query {
  allTasks(first: Int, after: String): [Task],
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the resolver for the <code>allTasks</code> query, the database connection can be used to retrieve data from the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const resolvers = {
  Query: {
    allTasks: async (obj, args, context) =&gt; {
      return context.db.select().from('tasks') //use `db` from the `context` object
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, if there are mutations, the database connection can be used in the resolvers to insert or update data to the database.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="realtime-updates-sync"><a class="anchor" href="#realtime-updates-sync"></a>Realtime Updates</h3>
<div class="paragraph">
<p>A core concept of the GraphQL specification is an operation type called <code>Subscription</code>, they provide a mechanism for real time updates.
To enable Subscriptions on the server, create an appropriate schema similar to the following example.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a schema to support subscriptions.</p>
<div class="paragraph">
<p>For example, in the following schema a <code>Task</code> type is defined, followed by required Mutations and Subscriptions.
When a new task is created, the resolver for that task publishes the result of this mutation to the <code>TaskCreated</code> channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { gql } = require('@aerogear/voyager-server')

const typeDefs = gql `
type Task {
  id: ID!
  title: String!
  description: String!
}

type Mutation {
  createTask(title: String!, description: String!): Task
}

type Subscription {
  taskCreated: Task
}
`

const resolvers = {
    Mutation: {
        createTask: async (obj, args, context, info) =&gt; {
            const result = tasks.create(args)
            pubSub.publish('TaskCreated', {
                taskCreated: result
              });
            return result
        }
    },
    Subscription: {
        taskCreated: {
            subscribe: () =&gt; pubSub.asyncIterator('TaskCreated')
        }
  },
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The pubSub mechanism used in the above example is deliberately ommited to focus on the GraphQL aspects of
Subscriptions. For more information on the available PubSub implementations see: <a href="https://www.apollographql.com/docs/apollo-server/features/subscriptions.html#PubSub-Implementations">PubSub Implementations</a>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Use the <code>subscriptions-transport-ws</code> package to set up the server.</p>
<div class="paragraph">
<p>For more information on how to use and configure <code>SubscriptionServer</code> see the <a href="https://www.apollographql.com/docs/graphql-subscriptions/setup.html#subscription-server">Apollo Subscription Server documentation</a>.</p>
</div>
<div class="paragraph">
<p>Using the example server described in <a href="#sync-server-getting-started">[sync-server-getting-started]</a> you can add subscriptions as follows by introducing http and wraping our express app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const http = require('http')
const { SubscriptionServer } = require('subscriptions-transport-ws')
const { execute, subscribe } = require('graphql')

const httpServer = http.createServer(app)

server.applyMiddleware({ app })

httpServer.listen(4000, () =&gt; {
  new SubscriptionServer ({
    execute,
    subscribe,
    schema: server.schema
  }, {
    server: httpServer,
    path: '/graphql'
  })
})</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For information on how to protect this subscription server with Identity Management see <a href="#sync-server-auth">[sync-server-auth]</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Additional Information</div>
<ul>
<li>
<p>For more information on GraphQL subscriptions, see the <a href="https://www.apollographql.com/docs/apollo-server/features/subscriptions.html">Subscriptions documentation</a>.</p>
</li>
<li>
<p>For documentation on how to use Subscriptions on your client, see <a href="#sync-js-client-realtime-updates">Realtime Updates</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="authentication-and-authorization-sync"><a class="anchor" href="#authentication-and-authorization-sync"></a>Authentication and Authorization using Keycloak</h3>
<div class="paragraph">
<p>Using the Identity Management service and the <a href="https://www.npmjs.com/package/@aerogear/voyager-keycloak">@aerogear/voyager-keycloak</a> module, it is possible to add security to a Sync Server application.</p>
</div>
<div class="paragraph">
<p>The <code>@aerogear/voyager-keycloak</code> module provides the following features out of the box:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authentication - Ensure only authenticated users can access your server endpoints, including the main GraphQL endpoint.</p>
</li>
<li>
<p>Authorization - Use the <code>@hasRole()</code> directive within the GraphQL schema to implement role based access control (RBAC) on the GraphQL level.</p>
</li>
<li>
<p>Integration with GraphQL context - Use the <code>context</code> object within the GraphQL resolvers to access user credentials and several helper functions.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>There is a Keycloak service available.</p>
</li>
<li>
<p>You must add a valid <code>keycloak.json</code> config file to your project.</p>
<div class="ulist">
<ul>
<li>
<p>Create a client for your application in the Keycloak administration console.</p>
</li>
<li>
<p>Click on the Installation tab.</p>
</li>
<li>
<p>Select <strong>Keycloak OIDC JSON</strong> for Format option, and click <strong>Download</strong>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="protecting-sync-server-using-keycloak"><a class="anchor" href="#protecting-sync-server-using-keycloak"></a>Protecting Sync Server using Keycloak</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Import the <code>@aerogear/voyager-keycloak</code> module</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { KeycloakSecurityService } = require('@aerogear/voyager-keycloak')</code></pre>
</div>
</div>
</li>
<li>
<p>Read the Keycloak config and pass it to initialise the <code>KeycloakSecurityService</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const keycloakConfig = JSON.parse(fs.readFileSync(path.resolve(__dirname, './path/to/keycloak.json')))
const keycloakService = new KeycloakSecurityService(keycloakConfig)</code></pre>
</div>
</div>
</li>
<li>
<p>Use the <code>keycloakService</code> instance to protect your app:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const app = express()
keycloakService.applyAuthMiddleware(app)</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Voyager server so that the <code>keycloakService</code> is used as the security service:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const voyagerConfig = {
  securityService: keycloakService
}
const server = VoyagerServer(apolloConfig, voyagerConfig)</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/aerogear/voyager-server/blob/master/examples/keycloak">Keycloak Example Server Guide</a> has an example server based off the instructions above and shows all of the steps needed to get it running.</p>
</div>
</div>
<div class="sect3">
<h4 id="protecting-subscriptions-using-keycloak"><a class="anchor" href="#protecting-subscriptions-using-keycloak"></a>Protecting Subscriptions using Keycloak</h4>
<div class="paragraph">
<p>If you have set up a subscription server as described in <a href="#sync-server-realtime-updates">Realtime Updates</a> and you have set up Identity Management as described above then your application should make use of the <code>onConnect</code> function to validate the token provided by the client. An example implementation of <code>onConnect</code> is shown below with a <code>KeycloakService</code> set up as shown above in <a href="#sync-server-auth">Setting Up Keycloak Protection in Sync Server</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>  new SubscriptionServer ({
    execute,
    subscribe,
    onConnect: async connectionParams =&gt; {
      return await keycloakService.validateToken(connectionParams)
    },
    schema: server.schema
  }, ...)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-the-hasrole-directive-in-a-schema"><a class="anchor" href="#using-the-hasrole-directive-in-a-schema"></a>Using the hasRole directive in a schema</h4>
<div class="paragraph">
<p>The Voyager Keycloak module provides the <code>@hasRole</code> directive to define role based authorisation in your schema. The <code>@hasRole</code> directive is a special annotation that can be applied to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fields</p>
</li>
<li>
<p>Queries</p>
</li>
<li>
<p>Mutations</p>
</li>
<li>
<p>Subscriptions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>@hasRole</code> usage is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@hasRole(role: String)</code></p>
</li>
<li>
<p>Example - <code>@hasRole(role: "admin"])</code></p>
</li>
<li>
<p>If the authenticated user has the role <code>admin</code> they will be authorized.</p>
</li>
<li>
<p><code>@hasRole(role: [String])</code></p>
</li>
<li>
<p>Example - <code>@hasRole(role: ["admin", "editor"])</code></p>
</li>
<li>
<p>If the authenticated user has at least one of the roles in the list, they will be authorized.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The default behaviour is to check client roles. For example, <code>@hasRole(role: "admin")</code> will check that user has a client role called <code>admin</code>. <code>@hasRole(role: "realm:admin")</code> will check if that user has a realm role called <code>admin</code></p>
</div>
<div class="paragraph">
<p>The syntax for checking a realm role is <code>@hasRole(role: "realm:&lt;role&gt;")</code>. For example, <code>@hasRole(role: "realm:admin")</code>. Using a list of roles, it is possible to check for both client and realm roles at the same time.</p>
</div>
<div class="paragraph">
<div class="title">Example: Using the @hasRole Directive to Apply Role Based Authorization in a Schema</div>
<p>The following example demonstrates how the <code>@hasRole</code> directive can be used to define role based authorization on various parts of a GraphQL schema. This example schema represents publishing application like a news or blog website.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">type Post {
  id: ID!
  title: String!
  author: Author!
  content: String!
  createdAt: Int!
}

type Author {
  id: ID!
  name: String!
  posts: [Post]!
  address: String! @hasRole(role: "admin")
  age: Int! @hasRole(role: "admin")
}

type Query {
  allPosts:[Post]!
  getAuthor(id: ID!):Author!
}

type Mutation {
  editPost:[Post]! @hasRole(role: ["editor", "admin"])
  deletePost(id: ID!):[Post] @hasRole(role: "admin")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Post</code> - This might be an article or a blog post</p>
</li>
<li>
<p><code>Author</code> - This would represent the person that authored a Post</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are two Queries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>allPosts</code> - This might return a list of posts</p>
</li>
<li>
<p><code>getAuthor</code> - This would return details about an Author</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are two Mutations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>editPost</code> - This would edit an existing post</p>
</li>
<li>
<p><code>deletePost</code> - This would delete a post.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Role Based Authorization on Queries and Mutations</div>
<p>In the example schema, the <code>@hasRole</code> directive has been applied to the <code>editPost</code> and <code>deletePost</code> mutations. The same could be done on Queries.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only users with the roles <code>editor</code> and/or <code>admin</code> are allowed to perform the <code>editPost</code> mutation.</p>
</li>
<li>
<p>Only users with the role <code>admin</code> are allowed to perform the <code>deletePost</code> mutation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This example shows how the <code>@hasRole</code> directive can be used on various queries and mutations.</p>
</div>
<div class="paragraph">
<div class="title">Role Based Authorization on Fields</div>
<p>In the example schema, the <code>Author</code> type has the fields <code>address</code> and <code>age</code> which both have <code>hasRole(role: "admin")</code> applied.</p>
</div>
<div class="paragraph">
<p>This means that users without the role <code>admin</code> are not authorized to request these fields in any query or mutation.</p>
</div>
<div class="paragraph">
<p>For example, non admin users are allowed to run the <code>getAuthor</code> query, but they cannot request back the <code>address</code> or <code>age</code> fields.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="server-files"><a class="anchor" href="#server-files"></a>Enabling file uploads</h3>
<div class="paragraph">
<p>Sync Server provides support for uploading binary data along with the GraphQL queries.
The implementation relies on upstream <code>Apollo Server</code> capabilities.</p>
</div>
<div class="paragraph">
<p>The upload functionality uses the GraphQL multipart form requests specification.
File upload needs to be implemented on both server and client:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the client HTML FileList objects are mapped into a mutation and sent to the server in a multipart request.</p>
</li>
<li>
<p>On the server: The multipart request is handled. The server processes it and provides an upload argument to a resolver.
In the resolver function, the upload promise resolves an object.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
File upload is based on <a href="https://github.com/jaydenseric/graphql-multipart-request-spec">graphql-multipart-request-spec</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To enable file uploads, create a schema and use the <code>Upload</code> scalar.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { ApolloServer, gql } = require('apollo-server');

const typeDefs = gql`
  type File {
    filename: String!
    mimetype: String!
    encoding: String!
  }
  type Query {
    uploads: [File]
  }
  type Mutation {
    singleUpload(file: Upload!): File!
  }
`;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following schema enables file uploads. The <code>Upload</code> scalar will be injected as one of the arguments in the resolvers.
The <code>Upload</code> scalar contains all file metadata and a <a href="https://nodejs.org/api/stream.html#stream_readable_streams">Readable Stream</a> that can be used to save the file to a specific location.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">    async singleUpload(parent, { file }) {
      const { stream, filename, mimetype, encoding } = await file;
      // Save file and return required metadata
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://blog.apollographql.com/file-uploads-with-apollo-server-2-0-5db2f3f60675">Official Apollo blog post</a> for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="metrics-and-logging"><a class="anchor" href="#metrics-and-logging"></a>Metrics and Logging</h3>
<div class="sect3">
<h4 id="sync-server-metrics"><a class="anchor" href="#sync-server-metrics"></a>Metrics</h4>
<div class="paragraph">
<p>Sync Server can expose a variety of useful metrics that can be consumed and visualised by the Mobile Metrics service. (Prometheus for data collection and Grafana for Visualisation).</p>
</div>
<div class="paragraph">
<p>The <code>@aerogear/voyager-metrics</code> module can be used to mount a metrics middleware, exposing a metrics endpoint that can be consumed by prometheus (default: <code>/metrics</code>).</p>
</div>
<div class="sect4">
<h5 id="enabling-metrics-in-sync-server"><a class="anchor" href="#enabling-metrics-in-sync-server"></a>Enabling Metrics in Sync Server</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Import the <code>@aerogear/voyager-metrics</code> module.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const metrics = require('@aerogear/voyager-metrics')</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the metrics middleware to your Express app. This will expose metrics at the given endpoint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const app = express()
metrics.applyMetricsMiddlewares(app, { path: '/metrics' })</code></pre>
</div>
</div>
</li>
<li>
<p>Inject the metrics module into Sync Server. This will ensure metrics at the GraphQL level can be exposed.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const voyagerConfig = {
  metrics
}
const server = VoyagerServer(apolloConfig, voyagerConfig)</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/aerogear/voyager-server/blob/master/examples/metrics">Metrics Example Server Guide</a> has an example server based off the instructions above and shows all of the steps needed to get it running.</p>
</div>
</div>
<div class="sect4">
<h5 id="monitoring-a-sync-server-application"><a class="anchor" href="#monitoring-a-sync-server-application"></a>Monitoring a Sync Server Application</h5>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have provisioned the Mobile Metrics service.</p>
</li>
<li>
<p>You have provisioned your Data Sync service.</p>
</li>
<li>
<p>You have enabled metrics in Sync Server.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Mobile Metrics Service and your Sync Server application must be provisioned in the same OpenShift project to access data.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="overview"><a class="anchor" href="#overview"></a>Overview</h5>
<div class="paragraph">
<p>As there can be multiple Sync Server applications in a namespace, Sync Server application provisioning procedure creates a new Grafana dashboard for the Sync Server application
that is being provisioned.</p>
</div>
<div class="paragraph">
<p>After the Mobile Metrics Service (includes Grafana for visualization and the Prometheus monitoring system) and your Sync Server application are provisioned,
you should be able to see the "Data Sync Metrics - &lt;your app name&gt;" in the list of available dashboards (navigate to Grafana&#8217;s exposed URL &#8594; Log in &#8594;
Home &#8594; Select <strong>Data Sync Metrics - &lt;your app name&gt;</strong>).</p>
</div>
<div class="sect5">
<h6 id="dashboard-panel-descriptions"><a class="anchor" href="#dashboard-panel-descriptions"></a>Dashboard panel descriptions</h6>
<div class="paragraph">
<p>The Data Sync dashboard consists of several panels which give you an overview of the specific
events and resources, such as memory usage, CPU usage, resolved operation count etc.</p>
</div>
<div class="paragraph">
<p>The dashboard is separated into 2 section. "Client" section shows some basic metrics about the clients and users and the "Server" secion shows some metrics about the server status.</p>
</div>
<div class="paragraph">
<p>Below you will find a detailed description of each panel and its values.</p>
</div>
<div class="paragraph">
<div class="title">Singlestat Panels</div>
<p>Singlestat panels show you the main summary of a single data series.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>CPU Usage</strong>: CPU usage percentage of the Sync Server application used currently.</p>
</li>
<li>
<p><strong>Memory Usage</strong>: The amount of memory currently used by the Sync Server application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Graph panels</div>
<p>Used to show how certain values change over time, e.g. the number of operations resolved.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Unique Clients Over Time</strong>: Overview of the number of unique clients over the selected time range. Note that a "client" is a an application installation on a device.
The client id is reset when the application is reinstalled on the same device.</p>
</li>
<li>
<p><strong>Unique Users Over Time</strong>: Overview of the number of unique users over the selected time range. Note that a "user" is a user who is authenticated with the Identity Management.</p>
</li>
<li>
<p><strong>Memory Usage in Time</strong>: The amount of memory used by the Sync Server application over time.</p>
</li>
<li>
<p><strong>CPU Usage in Time</strong>: The percentage of CPU used by the Sync Server application over time.</p>
</li>
<li>
<p><strong>Queries/Mutations Resolved</strong>: Overview of the resolved queries and mutations over time.</p>
</li>
<li>
<p><strong>Resolver Timings</strong>: Overview of the how long it took to resolve operations over time.</p>
</li>
<li>
<p><strong>Server Response Time</strong>: Overview of the how long it took the server to respond the requests.</p>
</li>
<li>
<p><strong>Operations vs Conflicts</strong>: Overview of the resolver executions and the conflicts happened.</p>
</li>
<li>
<p><strong>Conflicts Over Time per Operation</strong>: Overview of the conflicts and what operation caused them.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="additional-resources"><a class="anchor" href="#additional-resources"></a>Additional resources</h5>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.grafana.org/features/panels/singlestat/#singlestat-panel">Singlestat Panel</a></p>
</li>
<li>
<p><a href="http://docs.grafana.org/features/panels/graph/#graph-panel">Graph Panel</a></p>
</li>
<li>
<p><a href="https://grafana.com/plugins/grafana-piechart-panel">Pie Chart</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sync-server-audit-logs"><a class="anchor" href="#sync-server-audit-logs"></a>Audit Logs</h4>
<div class="paragraph">
<p>Audit logging is a mechanism to track all of the actions that occur inside your application. Audit Logging in Sync Server provides two main benefits.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It is possible to build a detailed audit trail of every action that has occured in the application. This can also include information about the user that performed the action, and the mobile device they were using.</p>
</li>
<li>
<p>The data from the audit logs can be aggregated and visualised to provide more insight into how your application is used.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="audit-logging-architecture"><a class="anchor" href="#audit-logging-architecture"></a>Audit Logging Architecture</h5>
<div class="paragraph">
<p>Audit logging can be enabled in Sync Server using the <a href="https://www.npmjs.com/package/@aerogear/voyager-audit">@aerogear/voyager-audit</a> module. When enabled, all actions such as GraphQL mutations, queries and subscriptions are logged in great detail to <code>stdout</code> in JSON format.</p>
</div>
<div class="paragraph">
<p>An audit log example message is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "level": 30,
  "time": 1545385687476,
  "pid": 11889,
  "hostname": "localhost.localdomain",
  "tag": "AUDIT",
  "logType" "RESOLVER_COMPLETION",
  "msg": "",
  "operationType": "query",
  "fieldName": "hello",
  "parentTypeName": "Query",
  "path": "hello",
  "success": true,
  "arguments": {},
  "clientInfo": {
    "clientId": "848d2a10-0505-11e9-888f-8d166149101a",
    "timestamp": 1545385686843,
    "data": {
      "app": {
        "appId": "org.aerogear.sync.example",
        "appVersion": "0.0.1",
        "sdkVersion": "0.0.1",
        "framework": "cordova"
      },
      "device": {
        "platform": "android",
        "platformVersion": "9",
        "device": "General Mobile GM8 Pro"
      }
    }
  },
  "userInfo": {
    "jti": "6ae0966a-9d61-430b-8167-d2b3c0b42709",
    "exp": 1545761725,
    "nbf": 0,
    "iat": 1545725725,
    "iss": "http://localhost:8080/auth/realms/voyager-testing",
    "aud": "voyager-testing",
    "sub": "ea2312e9-1aae-4b67-8674-a3aacf20a71d",
    "typ": "Bearer",
    "azp": "voyager-testing",
    "auth_time": 1545725725,
    "session_state": "1ba4d429-8010-4f38-8002-9cc72550850d",
    "acr": "1",
    "allowed-origins": [
      "*"
    ],
    "realm_access": {
      "roles": [
        "admin",
        "uma_authorization"
      ]
    },
    "resource_access": {
      "voyager-testing": {
        "roles": [
          "admin"
        ]
      },
      "account": {
        "roles": [
          "manage-account",
          "manage-account-links",
          "view-profile"
        ]
      }
    },
    "name": "Ali Ok",
    "preferred_username": "developer",
    "given_name": "Ali",
    "family_name": "Ok",
    "email": "aliok@example.com"
  },
  "v": 1
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>clientInfo</code> property of the audit log message is available only if the client is sending the client information to Sync Server. That has to be enabled separately in the client. Additionally, data in that property can only be collected if the app is a Cordova app or a native app. Simple web clients cannot get the device, client nor app details and cannot send this information.</p>
</div>
<div class="paragraph">
<p>The <code>userInfo</code> property is available only if Sync Server is protected by an identity manager, such as Keycloak, and if the user is authenticated. See  see <a href="#sync-server-auth">[sync-server-auth]</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="enabling-audit-logging-in-voyager-server"><a class="anchor" href="#enabling-audit-logging-in-voyager-server"></a>Enabling Audit Logging in Voyager Server</h5>
<div class="paragraph">
<p>Audit logging is enabled in Sync Server using the <a href="https://www.npmjs.com/package/@aerogear/voyager-audit">@aerogear/voyager-audit</a></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Import the <code>@aerogear/voyager-audit</code> module</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const auditLogger = require('@aerogear/voyager-audit')</code></pre>
</div>
</div>
</li>
<li>
<p>Inject the auditLogger module into the Sync Server. This enables audit logging within your application.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const voyagerConfig = {
  auditLogger
}
const server = VoyagerServer(apolloConfig, voyagerConfig)</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/aerogear/voyager-server/tree/master/examples/audit_logging">Audit Logging Example Server Guide</a> has an example server based off the instructions above and shows all of the steps needed to get it running.</p>
</div>
<div class="paragraph">
<p>Alternatively, if the default audit logger does not match your requirements, you can create an audit logger that implements the <code>AuditLogger</code> interface as defined below.</p>
</div>
<div class="listingblock">
<div class="title">Definition of the <code>AuditLogger</code> interface</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">export interface AuditLogger {
  logResolverCompletion(msg: string, success: boolean, obj: any, args: any, context: any, info: GraphQLResolveInfo): void
  logConflict (msg: string, serverData: any, clientData: any, obj: any, args: any, context: any, info: GraphQLResolveInfo): void
  auditLog(msg: string, obj: any, args: any, context: any, info: GraphQLResolveInfo): void
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example implements an <code>AuditLogger</code> and injects it into the Sync Server.
The example redacts the arguments using a <code>myCustomRedactionFunction</code> function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">const { buildPath } = require('@aerogear/voyager-tools')
// ...

const auditLogger = {
  auditLog: function(msg, obj, args, context, info){
    console.log(JSON.stringify(
      {
        audit: {
          tag: 'AUDIT',
          logType: logType,
          msg: msg || '',
          requestId: context &amp;&amp; context.request ? context.request.id : '',
          operationType: info.operation.operation,
          fieldName: info.fieldName,
          parentTypeName: info.parentType.name,
          path: buildPath(info.path),
          parent: obj,
          arguments: myCustomRedactionFunction(args),
          clientInfo: context &amp;&amp; context.request &amp;&amp; context.request.body &amp;&amp; context.request.body.extensions &amp;&amp; context.request.body.extensions.metrics || undefined,
          authenticated: !!(context &amp;&amp; context.auth &amp;&amp; context.auth.isAuthenticated()),
          userInfo: (context &amp;&amp; context.auth &amp;&amp; context.auth.accessToken) ? context.auth.accessToken.content : undefined
        }
      }
    ));
  },

  logResolverCompletion: function(msg, success, obj, args, context, info){
    console.log(JSON.stringify(
      {
        audit: {
          tag: 'AUDIT',
          logType: 'RESOLVER_COMPLETION',
          msg: msg || '',
          requestId: context &amp;&amp; context.request ? context.request.id : '',
          operationType: info.operation.operation,
          fieldName: info.fieldName,
          parentTypeName: info.parentType.name,
          path: buildPath(info.path),
          success,
          parent: obj,
          arguments: myCustomRedactionFunction(args),
          clientInfo: context &amp;&amp; context.request &amp;&amp; context.request.body &amp;&amp; context.request.body.extensions &amp;&amp; context.request.body.extensions.metrics || undefined,
          authenticated: !!(context &amp;&amp; context.auth &amp;&amp; context.auth.isAuthenticated()),
          userInfo: (context &amp;&amp; context.auth &amp;&amp; context.auth.accessToken) ? context.auth.accessToken.content : undefined
        }
      }
    ));
  },

  logConflict: function (msg, serverData, clientData, obj, args, context, info) {
    console.log(JSON.stringify(
      {
        audit: {
          tag: 'AUDIT',
          logType: LOG_TYPE_CONFLICT,
          msg: msg || '',
          requestId: context &amp;&amp; context.request ? context.request.id : '',
          operationType: info.operation.operation,
          fieldName: info.fieldName,
          parentTypeName: info.parentType.name,
          path: buildPath(info.path),
          parent: obj,
          arguments: myCustomRedactionFunction(args),
          clientInfo: context &amp;&amp; context.request &amp;&amp; context.request.body &amp;&amp; context.request.body.extensions &amp;&amp; context.request.body.extensions.metrics || undefined,
          authenticated: !!(context &amp;&amp; context.auth &amp;&amp; context.auth.isAuthenticated()),
          userInfo: (context &amp;&amp; context.auth &amp;&amp; context.auth.accessToken) ? context.auth.accessToken.content : undefined,
          conflict: true,
          conflictData: {
            message: msg,
            myCustomRedactionFunction(serverData),
            myCustomRedactionFunction(clientData),
          }
        }
      }
    ));
  }
}

// ...

const voyagerConfig = {
  auditLogger
}
const server = VoyagerServer(apolloConfig, voyagerConfig)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sending-device-information-in-sync-client"><a class="anchor" href="#sending-device-information-in-sync-client"></a>Sending Device Information in Sync Client</h5>
<div class="paragraph">
<p>See the <a href="#sync-js-client-audit-logs">Sync Client Audit Logs</a> section for more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="exploring-audit-logs"><a class="anchor" href="#exploring-audit-logs"></a>Exploring Audit Logs</h5>
<div class="paragraph">
<p>Sync Server simply prints audit logs to <code>stdout</code> and it is the responsibility of another component to pick up these logs and provide
functionality to the user to make use of the logs.</p>
</div>
<div class="paragraph">
<p>The <strong>EFK stack</strong> (ElasticSearch, Fluentd and Kibana) on OpenShift is the recommended solution in this guide. We provide Kibana dashboards with a number of useful visualisations and insights into Sync Server.</p>
</div>
<div class="paragraph">
<p>All application logs printed to <code>stdout</code> are sent to ElasticSearch by Fluentd. However, the audit log messages printed by <code>@aerogear/voyager-audit</code> are printed in a format that is used by the Kibana dashboards.</p>
</div>
</div>
<div class="sect4">
<h5 id="configuring-openshift-logging"><a class="anchor" href="#configuring-openshift-logging"></a>Configuring OpenShift Logging</h5>
<div class="paragraph">
<p>OpenShift logging can be enabled as described in <a href="https://docs.okd.io/3.11/install_config/aggregate_logging.html">OpenShift documentation</a>.</p>
</div>
<div class="paragraph">
<p>Once enabled, OpenShift logging will create a Fluentd instance per cluster node that reads the <code>stdout</code> and <code>stderr</code> of the pods in that node
and pushes the readings to the centralized ElasticSearch instance. Documents created in ElasticSearch instance can be then explored and
visualized by the Kibana instance, which is also installed by OpenShift logging.</p>
</div>
<div class="paragraph">
<p>OpenShift logging creates an index per namespace and that index is only available to users who have access to that namespace.
It also creates the index patterns in Kibana in the same way.</p>
</div>
<div class="paragraph">
<p>By default, OpenShift also provides a <a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/about.html">curator</a> which deletes the old
log messages from ElasticSearch to reduce storage needs and improve performance. This has an impact on audit trails and also metrics.</p>
</div>
<div class="paragraph">
<p>For long term audit trails, curator can be configured to delete messages older than your choice. If this is not sufficient,
Fluentd can be configured to write log messages to a separate storage, such as <a href="https://docs.fluentd.org/v0.12/articles/out_s3">S3</a>.</p>
</div>
<div class="paragraph">
<p>In terms of metrics, curator&#8217;s deletion age config should not be set shorter than the desired time range that you would like
to see the metrics for.</p>
</div>
</div>
<div class="sect4">
<h5 id="importing-kibana-saved-objects"><a class="anchor" href="#importing-kibana-saved-objects"></a>Importing Kibana Saved Objects</h5>
<div class="paragraph">
<p>Kibana is a visualization tool that has a great integration with ElasticSearch.</p>
</div>
<div class="paragraph">
<p>A template for Kibana saved objects is available. When the saved objects are imported, a number of saved searches, visualizations and a
dashboard are created in Kibana. These then can be used to have an overview of the Voyager application.</p>
</div>
<div class="paragraph">
<p>See the screenshot of the provided dashboard below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/kibana-dashboard-screenshot.png" alt="kibana dashboard screenshot">
</div>
</div>
<div class="paragraph">
<p>OpenShift logging creates ElasticSearch indices per namespace and the index names have the format <code>project.&lt;project-name&gt;.&lt;project-uid&gt;</code>.
For example <code>project.myproject.49f9a0b6-09b5-11e9-9597-069f7827c758</code>.</p>
</div>
<div class="paragraph">
<p>It also creates a Kibana index pattern for that index using the pattern <code>project.&lt;project-name&gt;.&lt;project-uid&gt;.*</code>.</p>
</div>
<div class="paragraph">
<p>In order to make sure the Kibana saved objects use the correct index pattern, project UID should be fetched and
fed to the Kibana import template.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">PROJECT_NAME=&lt;your_project_name&gt;
# login with your user that has access to your project
oc login
# get project UUID, which is used to build the index name
PROJECT_UUID=`oc get project $PROJECT_NAME -o go-template='{{.metadata.uid}}'`

# replace the placeholders in the template
sed \
    -e "s/&lt;PROJECT_NAME&gt;/${PROJECT_NAME}/g" \
    -e "s/&lt;PROJECT_UUID&gt;/${PROJECT_UUID}/g" \
 kibanaImportTemplate.json &gt; kibanaImport.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>A template, <code>kibanaImportTemplate.json</code> is available from the <a href="https://raw.githubusercontent.com/aerogear/voyager-server/master/doc/guides/kibanaImportTemplate.json">Voyager GitHub repo</a>.</p>
</div>
<div class="paragraph">
<p>Once the <code>kibanaImport.json</code> file is generated, import it into Kibana:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open Kibana using <code><a href="https://kibana.&lt;domain&gt;.com" class="bare">https://kibana.&lt;domain&gt;.com</a></code>. Replace <code>&lt;domain&gt;</code> with the name of the cluster&#8217;s main domain.</p>
</li>
<li>
<p>Click <strong>Management</strong> in the left</p>
</li>
<li>
<p>Click <strong>Saved Objects</strong></p>
</li>
<li>
<p>Click <strong>Import</strong> and select <code>kibanaImport.json</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Imported saved objects include the project name or the UID in their names, so that saved objects in differnt namespaces do not affect each other.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>No index pattern is created in Kibana if there are no logs generated by an application.</p>
</div>
<div class="paragraph">
<p>Also, if the fields referenced in the prepared Kibana saved objects do not exist, errors such as the following can be seen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: Importing AeroGear Data Sync - top level execution per platform - aaa (top_level_execution_per_platform_49f9a0b6-09b5-11e9-9597-069f7827c758) failed: Could not locate that index-pattern-field (id: audit.clientInfo.data.device.platform.raw)
Error: Could not locate that index-pattern-field (id: audit.clientInfo.data.device.platform.raw)</pre>
</div>
</div>
<div class="paragraph">
<p>Because of these conditions, Kibana saved objects have to be imported after there are some audit logs already in ElasticSearch.
At the moment, no mechanisms are provided to overcome this problem.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="viewing-the-dashboard-and-audit-logs"><a class="anchor" href="#viewing-the-dashboard-and-audit-logs"></a>Viewing the Dashboard and Audit Logs</h4>
<div class="paragraph">
<p>When the Kibana saved objects are imported, a dashboard is available with several visualizations that can be used as an
overview of the Voyager application status.</p>
</div>
<div class="paragraph">
<p>At the bottom of the dashboard, audit log messages can be explored directly.</p>
</div>
<div class="paragraph">
<p>For more information on how to use Kibana, see the <a href="https://www.elastic.co/products/kibana">Kibana documentation</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sync-js-client"><a class="anchor" href="#sync-js-client"></a>Data Sync Javascript Client</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sync-js-basic-concepts"><a class="anchor" href="#sync-js-basic-concepts"></a>Introduction</h3>
<div class="paragraph">
<p>The Sync Client uses the <a href="https://www.apollographql.com/docs/react">Apollo GraphQL Javascript client</a>, adding the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Offline query and mutation support</p>
</li>
<li>
<p>Conflict detection and resolution</p>
</li>
<li>
<p>Authentication and authorization support</p>
</li>
<li>
<p>Audit logging</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Because the Sync Client is an extension to Apollo, it works with all the frameworks that Apollo supports.</p>
</div>
<div class="paragraph">
<p>For React:
<a href="https://www.apollographql.com/docs/react/" class="bare">https://www.apollographql.com/docs/react/</a></p>
</div>
<div class="paragraph">
<p>For Angular:
<a href="https://www.apollographql.com/docs/angular/" class="bare">https://www.apollographql.com/docs/angular/</a></p>
</div>
<div class="sect3">
<h4 id="cache"><a class="anchor" href="#cache"></a>Cache</h4>
<div class="paragraph">
<p>In order to support offline use cases, the client SDK strongly leverages Apollo Cache layer.
See the <a href="https://www.apollographql.com/docs/react/advanced/caching.html">Apollo cache documentation</a> for more information.</p>
</div>
<div class="sect4">
<h5 id="querying-data"><a class="anchor" href="#querying-data"></a>Querying Data</h5>
<div class="paragraph">
<p>To work with cache effectively, AeroGear recommends using the <code>cache-first</code> fetchPolicy when performing queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">  return this.apollo.watchQuery({
    query: YOUR_QUERY,
    fetchPolicy: 'cache-first',
  });</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cache is populated by subscriptions, pooling or regular queries happening in UI.
See the <em>client-offline-support, Offline Support</em> section for more details.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="required-field-in-graphql-types"><a class="anchor" href="#required-field-in-graphql-types"></a>Required Field in GraphQL Types</h4>
<div class="paragraph">
<p>A field called <code>id</code> is required in all the types when design the GraphQL schema for an application.
The client SDK expects this field to be returned from the server for a query.
Without this field some offline functionalities does not work properly.</p>
</div>
<div id="sync-js-client-getting-started" class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have Node.js and npm installed.</p>
</li>
<li>
<p>You have created an empty web project that supports ES6, for example, using the <a href="https://webpack.js.org/guides/getting-started/">webpack getting started</a> guide.</p>
</li>
<li>
<p>You have completed the server getting started guide and the application is running.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This section describes how to use the Sync Client to create mobile and web applications that can communicate with the Voyager server application.</p>
</div>
<div class="paragraph">
<p>Data Sync provides JavaScript libraries which integrate your javascript app using with a server that also uses Data Sync.  The client libraries are based on the <a href="https://www.apollographql.com/docs/react/api/apollo-client.html">Apollo client</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="hello-world-sync"><a class="anchor" href="#hello-world-sync"></a>Hello World Sync</h4>
<div class="paragraph">
<p>Connecting our client to the server "Hello World" example. You will add the libraries to your mobile project, configure the client classes, connect to the server, and confirm that it works.</p>
</div>
<div class="listingblock">
<div class="title">Add our libraries to your javascript client,</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">npm install @aerogear/voyager-client</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is a simple code example to connect to and query our Sync Server.  To configure the client, a configuration object should be used. At a minimum, the <code>httpUrl</code> field is required and it is the url of the Voyager server application. If the client app uses subscription as well, then the <code>wsUrl</code> field is required too.</p>
</div>
<div class="paragraph">
<p>Core to connect to and query our server application would look like the following:</p>
</div>
<div class="listingblock">
<div class="title">src/index.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// gql is a utility function that handles gql queries
import gql from 'graphql-tag';

// createClient configures the Data Sync client based on options you provide
import {createClient} from '@aerogear/voyager-client';

// For our client application, we will connect to the local service.
let config = {
  httpUrl: "http://localhost:4000/graphql",
  wsUrl: "ws://localhost:4000/graphql",
}

async function helloWorld() {

  // Actually create the client
  let client = await createClient(config);

  // Execute the hello query
  client.query({
      fetchPolicy: 'network-only',
      query: gql`{hello}`
    })
    //Print the response of the query
    .then( ({data}) =&gt; {
      console.log(data.hello)
    });
}

helloWorld();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can build and run this code in your project. You should see "Hello world" in your JavaScript console. The server and client can now communicate.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sync-js-client-offline-and-conflict"><a class="anchor" href="#sync-js-client-offline-and-conflict"></a>Supporting offline operations</h3>
<div class="paragraph">
<p>The Sync Client provides first class support for performing GraphQL operations while offline. This is because the SDK uses the "cache-first" strategy when perform queries, regardless of the network status of the client. As illustrated in the diagram below, all the queries will be performed against the cache, and the Apollo client will manage filling the cache with data from the server. On top of that, the Sync Client uses a mutation store to support offline mutations.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/datasync-features.png" alt="datasync features">
</div>
</div>
<div class="paragraph">
<p>The mutation store is effectively a persisted queue, and it is used to hold query and mutation requests when the client is offline. If a client goes offline for a long period of time, it will be able to negotiate local updates with the server using conflict resolution strategies.</p>
</div>
<div class="paragraph">
<p>When a client becomes online from the offline state, the mutations that are persisted locally will be replicated back to the server, as shown in the diagram below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/datasync-going_offline.png" alt="datasync going offline">
</div>
</div>
<div class="paragraph">
<p>Developers can attach listeners to get notification about if a update is applied on the server or not, and take appropriate actions.</p>
</div>
<div class="sect3">
<h4 id="mutations-and-local-cache"><a class="anchor" href="#mutations-and-local-cache"></a>Mutations and Local Cache</h4>
<div class="paragraph">
<p>By default queries are cached based on the type and <code>id</code> field, and the results of performed queries are cached as well and they will be available when the client is offline.</p>
</div>
<div class="paragraph">
<p>Because of this, when mutations that can change query results are performed, the <code>refetchQueries</code> or <code>update</code> options of the <code>mutate</code> method should be used to ensure the local cache is kept up to date.</p>
</div>
<div class="paragraph">
<p>In the following example, the app will perform an <code>ADD_TASK</code> mutation which will create a new task. The app also has a <code>GET_TASKS</code> query to list all the tasks. In order to make sure the cache for the <code>GET_TASKS</code> query is kept up to date whenever a new task is created, the <code>update</code> option is used to add the newly created task to the cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">  client.mutate({
    mutation: ADD_TASK, variables: item,
    update: updateCacheOnAdd
  });

  function updateCacheOnAdd(cache, { data: { createTask } }) {
    let { allTasks } = cache.readQuery({ query: GET_TASKS });
    if (allTasks) {
      if (!allTasks.find((task) =&gt; task.id === createTask.id)) {
        allTasks.push(createTask);
      }
    } else {
      allTasks = [createTask];
    }
    cache.writeQuery({
      query: GET_TASKS,
      data: {
        'allTasks': allTasks
      }
    });
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see <a href="https://www.apollographql.com/docs/react/essentials/mutations.html#props">Apollo&#8217;s document about mutations</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="offline-workflow"><a class="anchor" href="#offline-workflow"></a>Offline Workflow</h4>
<div class="paragraph">
<p>If a mutation occurs while the device is offline, the client.mutate function:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>returns immediately</p>
</li>
<li>
<p>returns a promise with an error</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can check the <em>error</em> object to isolate errors relating to offline state.
Invoking the <code>watchOfflineChange()</code> method on an <em>error</em> object watches for when an offline change is synced with the server, and sends an notification when triggered.
after the device is online again.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">  client.mutate(...).catch((error)=&gt; {
    // 1. Detect if this was an offline error
   if(error.networkError &amp;&amp; error.networkError.offline){
     const offlineError: OfflineError =  error.networkError;
     // 2. We can still track when offline change is going to be replicated.
     offlineError.watchOfflineChange().then(...)
   }
  });</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In addition to watching individual mutations, you can add a global offline listener when creating a client.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="global-update-functions"><a class="anchor" href="#global-update-functions"></a>Global Update Functions</h5>
<div class="paragraph">
<p>Apollo client holds all mutation parameters in memory.
An offline Apollo client will continue to store mutation parameters and once online, it will restore all mutations to memory. Any Update Functions that are supplied to mutations cannot be cached by an Apollo client resulting in the loss of all optimisticResponses after a restart. <em>Update functions</em> supplied to mutations cannot be saved in the cache.
As a result, all <em>optimisticResponses</em> will disappear from the application after a restart and it will only reappear when the Apollo client becomes online and successfully syncs with the server.</p>
</div>
<div class="paragraph">
<p>To prevent the loss of all <em>optimisticResponses</em> after a restart, you can configure the <em>Update Functions</em> to restore all <em>optimisticResponses</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const updateFunctions = {
  // Can contain update functions from each component
  ...ItemUpdates,
  ...TasksUpdates
}

let config = {
  mutationCacheUpdates: updateFunctions,
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="online-only-queries"><a class="anchor" href="#online-only-queries"></a>Online Only Queries</h5>
<div class="paragraph">
<p>To ensure certain queries are only executed when the client is online, a GraphQL directive called <code>@onlineOnly</code> can be used to annotate a query, as the example shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">exampleQuery(...) @onlineOnly {
  ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sync-client-offline-queue-listener"><a class="anchor" href="#sync-client-offline-queue-listener"></a>Listening for Events</h4>
<div class="paragraph">
<p>To handle all notifications about offline related events, use the <strong>offlineQueueListener</strong> listener in the config object</p>
</div>
<div class="paragraph">
<p>The following events are emitted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>onOperationEnqueued</code> - Called when new operation is being added to offline queue</p>
</li>
<li>
<p><code>onOperationSuccess</code> - Called when back online and operation succeeds</p>
</li>
<li>
<p><code>onOperationFailure</code> - Called when back online and operation fails with GraphQL error</p>
</li>
<li>
<p><code>queueCleared</code> - Called when offline operation queue is cleared</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use this listener to build User Interfaces that show pending changes.</p>
</div>
</div>
<div class="sect3">
<h4 id="conflicts"><a class="anchor" href="#conflicts"></a>Conflicts</h4>
<div class="paragraph">
<p>A <strong>conflict</strong> occurs whenever two or more clients try to modify the same data in between synchronizations.</p>
</div>
<div class="paragraph">
<p><strong>Conflict resolution</strong> is how the application detects and resolves the conflict and ensures the correct data is stored. In most cases, the way conflicts are detected and resolved are incredibly specific to an application and the underlying data storage.</p>
</div>
<div class="paragraph">
<p>The Data Sync SDK provides some utilities to help applications detect and resolve conflicts on either server or client side. To handle conflicts on client side, developers need to configure their resolvers on the server side to return conflicts back to clients first. For more information, see the <a href="#sync-server-offline-and-conflict">Voyager server document</a>.</p>
</div>
<div class="paragraph">
<p>If conflicts need to be handled on client side, developers can either use the default conflict resolution implementations, or implement their own ones thanks to the pluggable conflict resolution mechanism.</p>
</div>
<div class="sect4">
<h5 id="pluggable-conflict-resolution-2"><a class="anchor" href="#pluggable-conflict-resolution-2"></a>Pluggable Conflict Resolution</h5>
<div class="paragraph">
<p>Pluggable conflict resolution is a concept that allows developers to implement their own conflict detection and resolution logic regardless of the data storage.</p>
</div>
<div class="paragraph">
<p>It has two parts: one for detecting conflicts, and the other for resolving conflicts.</p>
</div>
<div class="paragraph">
<p>To detect conflicts, developers can use either the default version-based conflict detection mechanism, or provide their own implementation via the <code>conflictStateProvider</code> option in the config object that is used to initialize the sync client.</p>
</div>
<div class="paragraph">
<p>To resolve conflicts, developers can either use the default conflict resolution strategy, or provide their own ones via the <code>conflictStrategy</code> option in the config object.</p>
</div>
</div>
<div class="sect4">
<h5 id="version-based-conflict-detection"><a class="anchor" href="#version-based-conflict-detection"></a>Version Based Conflict Detection</h5>
<div class="paragraph">
<p>For more details about how it works, see the <em>server-version-based-conflict-resolution, Voyager server document</em>.</p>
</div>
<div class="paragraph">
<p>On the client side, if this default implementation is used, developers need to make sure the version value is always passed to the server when a mutation is invoked.</p>
</div>
</div>
<div class="sect4">
<h5 id="conflict-resolution-strategies-2"><a class="anchor" href="#conflict-resolution-strategies-2"></a>Conflict Resolution Strategies</h5>
<div class="paragraph">
<p>To resolve conflicts on the client side, a <code>conflictStrategy</code> needs to be provided. If none is provided, by default, the <code>clientVersionWins</code> strategy is used. This means the SDK will automatically override the server data with the current client data.</p>
</div>
<div class="paragraph">
<p>To implement a custom conflict resolution strategy provide at least one of the parameters below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>strategies - a dictionary object where each key is the name of a mutation and the value is the custom action for a conflict caused by that mutation</p>
</li>
<li>
<p>default - the default behavior to use if one of your mutations is not listed in <code>strategies</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If strategies are provided but no default then <code>clientVersionWins</code> becomes the default.
If a mutation causes a conflict and you have not specified a conflict resolution strategy for that mutation, the system uses the <code>clientVersionWins</code> strategy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">//define a custom conflict resolver
let updateTaskConflictResolver = (serverData, clientData) =&gt; {
    ...
    return Object.assign(serverData, clientData);
};

let deleteTaskConflictResolver = (serverData, clientData) =&gt; {
    ...
    return serverData;
}

//define a default where the clientData is used
let defaultConflictResolver = (serverData, clientData) =&gt; {
    return clientData
}

//pass it to the config object
let config = {
...
  conflictStrategy: {
    strategies: {
      "TaskUpdated": updateTaskConflictResolver,
      "TaskDeleted": deleteTaskConflictResolver
    },
    default: defaultConflictResolver
  }
...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Client strategy is ignored when conflicts are resolved on the server.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="listening-to-conflicts"><a class="anchor" href="#listening-to-conflicts"></a>Listening to Conflicts</h5>
<div class="paragraph">
<p>Developers can supply their own <code>conflictListener</code> implementation to get notifications about conflicts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">let config = {
...
  conflictListener: {
    conflictOccurred: function(operationName, resolvedData, server, client) {
      console.log(`data: ${JSON.stringify(resolvedData)}, server: ${JSON.stringify(server)} client: ${JSON.stringify(client)} `);
    }
  }
...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sync-js-client-realtime-updates"><a class="anchor" href="#sync-js-client-realtime-updates"></a>Implementing realtime updates</h3>
<div class="paragraph">
<p>A core concept of the GraphQL specification is an operation type called <code>Subscription</code>, they provide a mechanism for real time updates.
For more information on GraphQL subscriptions  see the <a href="https://www.apollographql.com/docs/apollo-server/features/subscriptions.html">Subscriptions documentation</a>.</p>
</div>
<div class="paragraph">
<p>To do this GraphQL Subscriptions utilise websockets to enable clients to subscribe to published changes.</p>
</div>
<div class="paragraph">
<p>The architecture of websockets is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client connects to websocket server.</p>
</li>
<li>
<p>Upon certain events, the server can publish the results of these events to the websocket.</p>
</li>
<li>
<p>Any <em>currently connected</em> client to that websocket receives these results.</p>
</li>
<li>
<p>The client can close the connection at any time and no longer receives updates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Websockets are a perfect solution for delivering messages to currently active clients.
To receive updates the client must be currently connected to the websocket server, updates made over this websocket while the client is offline are not consumed by the client.
For this use case Push Notifications are recommended.</p>
</div>
<div class="paragraph">
<p>Sync Client comes with subscription support out of the box including auto-reconnection upon device restart or network reconnect.
To enable subscriptions on your client set the following
paramater in the Sync Client config object. A DataSyncConfig interface is also available from Sync Client if you wish to use it.</p>
</div>
<div class="sect3">
<h4 id="setting-up-a-client-to-use-subscriptions"><a class="anchor" href="#setting-up-a-client-to-use-subscriptions"></a>Setting up a client to use subscriptions</h4>
<div class="paragraph">
<p>To set up a client to use subscriptions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Provide a <code>wsUrl</code> string in the config object as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const config = {
    wsUrl: "ws://&lt;your_websocket_url&gt;"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&lt;your_websocket_url&gt;</code> is the full URL of the websocket endpoint of your GraphQL server.</p>
</div>
</li>
<li>
<p>Use the object from step 1 to initialise Sync Client:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { createClient } = require("@aerogear/voyager-client");

const client = createClient(config)</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="using-subscriptions"><a class="anchor" href="#using-subscriptions"></a>Using Subscriptions</h4>
<div class="paragraph">
<p>A standard flow to utilise subscriptions is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make a network query to get data from the server</p>
</li>
<li>
<p>Watch the cache for changes to queries</p>
</li>
<li>
<p>Subscribe to changes pushed from the server</p>
</li>
<li>
<p>Unsubscibe when leaving the view where there is an active subscription</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the three examples below, <code>subscribeToMore</code> ensures that any further updates received from the server force the updateQuery function to be called with <code>subscriptionData</code> from the server.</p>
</div>
<div class="paragraph">
<p>Using <code>subscribeToMore</code> ensures the cache is easily updated as all GraphQL queries are automatically notified.</p>
</div>
<div class="paragraph">
<p>For more information, see the  <a href="https://www.apollographql.com/docs/angular/features/subscriptions.html#subscribe-to-more">subscribeToMore documentation</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">getTasks() {
  const tasks = client.watchQuery({
    query: GET_TASKS
  });

  tasks.subscribeToMore({
    document: TASK_ADDED_SUBSCRIPTION,
    updateQuery: (prev, { subscriptionData }) =&gt; {
      if(subscriptionData.data){
        const newTask = subscriptionData.data.taskAdded;
        if (prev.allTasks.find(task =&gt; task.id === newTask.id)) {
          return prev;
        } else {
          return Object.assign({}, prev, {
            allTasks: [...prev.allTasks, newTask]
          });
        }
      }
    }
  });
  return tasks;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the above example some deduplication is performed to ensure the same task is not returned to the UI when it is
already present.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can then use this query in our application to subscribe to changes so that the front end is always updated when new
data is returned from the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">this.tasks = [];
this.getTasks().subscribe(result =&gt; {
  this.tasks = result.data &amp;&amp; result.data.allTasks;
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that it is also a good idea to unsubscribe from a query upon leaving a page. This prevents possible memory leaks.
This can be done by calling unsubscribe() as shown in the following example. This code should be placed in the appropriate place.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">this.getTasks().unsubscribe();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="handling-network-state-changes"><a class="anchor" href="#handling-network-state-changes"></a>Handling network state changes</h4>
<div class="paragraph">
<p>When using subscriptions to provide your client with realtime updates it is important to monitor network state because the client will be out of sync if the server if updated when the the client is offline.</p>
</div>
<div class="paragraph">
<p>To avoid this, Sync Client provides a <code>NetworkStatus</code> interface which can be used along with the <code>NetworkInfo</code> interface to implement custom checks of network status.</p>
</div>
<div class="paragraph">
<p>For more information about how to import and configure a custom network status checker, see <a href="#sync-js-client-advanced-topics">Advanced Topics</a>.</p>
</div>
<div class="paragraph">
<p>Use the following example to re-run a query after a client returns to an online state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { CordovaNetworkStatus, NetworkInfo } = require("@aerogear/voyager-client");
const networkStatus = new CordovaNetworkStatus();

networkStatus.onStatusChangeListener({
  onStatusChange(networkInfo: NetworkInfo) {
    const online = networkInfo.online;
    if (online) {
      client.watchQuery({
        query: GET_TASKS
      });
    }
  }
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sync-js-client-auth"><a class="anchor" href="#sync-js-client-auth"></a>Authentication and Authorization</h3>
<div class="paragraph">
<p>With Sync Client, user information can be passed to a Data Sync server application in two ways: headers or tokens.</p>
</div>
<div class="paragraph">
<p>Headers are used to authentication HTTP requests to the server, which are used for queries and mutations.</p>
</div>
<div class="paragraph">
<p>Tokens are used to authenticate WebSocket connections, which are used for subscriptions.</p>
</div>
<div class="paragraph">
<p>Both of them can be set via the <code>authContextProvider</code> configuration option. Here is an example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">//get the token value from somewhere, for example the authentication service
const token = "REPLACE_WITH_REAL_TOKEN";

const config = {
  ...
  authContextProvider: function() {
    return {
      header: {
        "Authorization": `Bearer ${token}`
      },
      token: token
    }
  },
  ...
};

//create a new client</code></pre>
</div>
</div>
<div class="paragraph">
<p>For information about how to perform authentication and authorization on the server, see the <a href="#sync-server-auth">Server Authentication and Authorization Guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="js-client-files"><a class="anchor" href="#js-client-files"></a>File Upload Client</h3>
<div class="paragraph">
<p>Sync Client provides support for uploading binary data along with the GraphQL queries.
The binary upload implementation uses the <code>apollo-upload-client</code> package built by the Apollo community.</p>
</div>
<div class="sect3">
<h4 id="introduction-2"><a class="anchor" href="#introduction-2"></a>Introduction</h4>
<div class="paragraph">
<p>The upload functionality uses the GraphQL multipart form requests specification.
The File upload needs to be implemented on both server and client:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the client HTML FileList objects are mapped into a mutation and sent to the server in a multipart request.</p>
</li>
<li>
<p>On the server: The multipart request is handled. The server processes it and provides an upload argument to a resolver.
In the resolver function, the upload promise resolves an object.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
File upload is based on <a href="https://github.com/jaydenseric/graphql-multipart-request-spec">graphql-multipart-request-spec</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="enabling-file-upload"><a class="anchor" href="#enabling-file-upload"></a>Enabling File Upload</h4>
<div class="paragraph">
<p>File upload feature needs to be enabled by passing <code>fileUpload</code> flag to config object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const config = {
  ...
  fileUpload: true
  ...
};

//create a new client</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="uploading-files-from-graphql"><a class="anchor" href="#uploading-files-from-graphql"></a>Uploading Files from GraphQL</h3>
<div class="paragraph">
<p>File upload capability adds a new GraphQL scalar <code>Upload</code> that can be used for mutations that operate on binary data.
The <code>Upload</code> scalar maps html <code>FileList</code> HTML5 object in GraphQL schemas.
The first step required to work with binary uploads is to write mutation that will contain <code>Upload</code> scalar.
The following example demonstrates how to upload a profile picture:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import gql from 'graphql-tag'
import { Mutation } from 'react-apollo'

export const UPLOAD_PROFILE = gql`
mutation changeProfilePicture($file: Upload!) {
  changeProfilePicture(file: $file) {
    filename
    mimetype
    encoding
  }
}
`;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="executing-mutations"><a class="anchor" href="#executing-mutations"></a>Executing mutations</h4>
<div class="paragraph">
<p>The <code>Upload</code> scalar will be mapped  to object returned from HTML file input.</p>
</div>
<div class="paragraph">
<p>The following example shows file upload in a React application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const uploadOneFile = () =&gt; {
  return (
    &lt;Mutation mutation={UPLOAD_PROFILE}&gt;
      {uploadFile =&gt; (
        &lt;input
        type="file"
        required
        onChange={({ target: { validity, files: [file] } }) =&gt;
          validity.valid &amp;&amp; uploadFile({ variables: { file } });
        }
       /&gt;
      )}
    &lt;/Mutation&gt;
  );
};</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sync-js-client-audit-logs"><a class="anchor" href="#sync-js-client-audit-logs"></a>Audit Logs</h3>
<div class="paragraph">
<p>As described in the <a href="#sync-server-audit-logs">Server Audit Logs</a> section, device information can be logged as part of an audit log message. To enable it:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Cordova plugin <code>cordova-plugin-aerogear-metrics</code> has to be installed so that the device, client and app information can be collected.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cordova plugin add cordova-plugin-aerogear-metrics</code></pre>
</div>
</div>
</li>
<li>
<p>Set <code>auditLogging</code> to true when creating a client instance.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import { createClient } from '@aerogear/voyager-client';

const config = {
  ...
  auditLogging: true,
  ...
}

return await createClient(config);</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="sync-js-client-advanced-topics"><a class="anchor" href="#sync-js-client-advanced-topics"></a>Advanced Topics</h3>
<div class="sect3">
<h4 id="network-status"><a class="anchor" href="#network-status"></a>Network Status</h4>
<div class="paragraph">
<p>The <a href="https://github.com/aerogear/aerogear-js-sdk/blob/master/packages/sync/src/offline/network/NetworkStatus.ts">NetworkStatus</a> interface can be used to check the current network status, or register a listener to perform certain actions when the status of the network changes.</p>
</div>
<div class="paragraph">
<p>Two default implementations are provided to support <a href="https://github.com/aerogear/aerogear-js-sdk/blob/master/packages/sync/src/offline/network/WebNetworkStatus.ts">web browsers</a> and <a href="https://github.com/aerogear/aerogear-js-sdk/blob/master/packages/sync/src/offline/network/CordovaNetworkStatus.ts">Cordova</a>. The following example demonstrates how to register a listener using <code>CordovaNetworkStatus</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import { CordovaNetworkStatus, NetworkInfo } from '@aerogear/voyager-client';
const networkStatus = new CordovaNetworkStatus();

networkStatus.onStatusChangeListener({
  onStatusChange: info =&gt; {
    const online = info.online;
    if (online) {
      //client is online, perform some actions
    } else {
      //client is offline
    }
  }
});

let config = {
  ...
  networkStatus: networkStatus,
  ...
};

//create a new client using the config</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="logging-debug-messages"><a class="anchor" href="#logging-debug-messages"></a>Logging Debug Messages</h4>
<div class="paragraph">
<p>The Sync Client uses the <a href="https://www.npmjs.com/package/debug">debug module</a> to log debug messages.</p>
</div>
<div class="paragraph">
<p>To enable debug logs, run the following code in a browser&#8217;s console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">localStorage.debug = 'AeroGearSync:*'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Certain features can be enabled separately:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">localStorage.debug = 'AeroGearSync:OfflineMutations*'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="optimistic-ui"><a class="anchor" href="#optimistic-ui"></a>Optimistic UI</h4>
<div class="paragraph">
<p>By default mutations are not applied to the UI until responses are received from the server. To provide better user experience, an application may want to update the UI immediately. <a href="https://www.apollographql.com/docs/react/api/react-apollo.html#graphql-mutation-options-optimisticResponse">Optimistic response</a> is an easy way to achieve this goal, and Sync Client provides a helper method to work with optimistic responses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript"> import { createOptimisticResponse } from "@aerogear/voyager-client";

 client.mutate({
   mutation: ADD_TASK,
   variables: item,
   optimisticResponse: createOptimisticResponse("createTask", "Task", item);
 });</code></pre>
</div>
</div>
<div class="paragraph">
<p>To detect if the provided data is an optimistic response, the <code>optimisticResponse</code> flag can be used.</p>
</div>
<div class="paragraph">
<p>The <code>OptimisticResponse</code> feature and the <a href="#sync-client-offline-queue-listener">offlineQueueListener</a> can be used together to deliver great offline experience for an application.</p>
</div>
<div class="paragraph">
<p>See the <a href="showcase-apps.html" class="page">Showcase Apps section</a> for more information.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sync-server-openshift"><a class="anchor" href="#sync-server-openshift"></a>Running Data Sync on OpenShift</h2>
<div class="sectionbody">
<div id="sync-server-getting-started-openshift" class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have Docker installed on your local machine.</p>
</li>
<li>
<p>You have access to an OpenShift cluster with the Service Catalog.</p>
</li>
<li>
<p>You have completed the server getting started guide.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="overview-2"><a class="anchor" href="#overview-2"></a>Overview</h3>
<div class="paragraph">
<p>To connect your Data Sync server and client to other services, you need to run your application in OpenShift.  Data Sync provides a service catalog item to help with this.</p>
</div>
<div class="paragraph">
<p>Data Sync requires your server application to be packaged as a Docker formatted container and published to a public respository such as <a href="https://hub.docker.com/">Docker hub</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="building-and-publishing-the-container"><a class="anchor" href="#building-and-publishing-the-container"></a>Building and publishing the Data Sync server container</h3>
<div class="paragraph">
<p>To build a server into a container, create a <code>Dockerfile</code> in the project&#8217;s directory.  This container will need to include your server source code, its dependencies, and be configured to execute your server.</p>
</div>
<div class="paragraph">
<p>As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-dockerfile hljs" data-lang="dockerfile">FROM node:8
WORKDIR /usr/src/app
# copy Node.js specific files
COPY package*.json ./
# copy application source file to the workdir
COPY index.js .
RUN npm install
# TCP port that application is listening on
EXPOSE 4000
CMD [ "node", "index.js" ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Build the Docker container and tag it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ docker build . --tag  &lt;your-repo&gt;/&lt;container-name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Push your container to Dockerhub&#8217;s repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ docker push &lt;your-repo&gt;/&lt;container-name&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sync-server-provisioning-data-sync"><a class="anchor" href="#sync-server-provisioning-data-sync"></a>Provisioning the Data Sync server application as a service</h3>
<div class="paragraph">
<p>To provision the Data Sync mobile service:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the OpenShift console.</p>
</li>
<li>
<p>Choose a project where you have previously provisioned Mobile Developer Console.</p>
</li>
<li>
<p>Select <strong>Catalog</strong> from the left hand menu.</p>
<div class="paragraph">
<p>You can filter the catalog items to only show mobile specific items by selecting the <strong>Mobile</strong> tab.</p>
</div>
</li>
<li>
<p>Choose the Data Sync service.</p>
</li>
<li>
<p>Follow the wizard for provisioning that service.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If prompted to <strong>Create a Binding</strong>, choose <strong>Do not bind at this time</strong>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Fill in all of the required parameters for the service:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sync-app-creation-dialog.png" alt="Sync Application Creation Dialog">
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Configuration</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sync Application Name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fill in name of your Data Sync application</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sync Application Docker image</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fill in URL too your Data Sync application docker image</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sync Application Docker image version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">latest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tag of your docker image</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sync Application Port</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port number that Data Sync application is listening on</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sync Application metrics endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/metrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the metrics endpoint (default value is recommended)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sync Application GraphQL Endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/graphql</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the GraphQL endpoint (default value is recommended)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Server Hostname</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database server hostname that is used to connect by the Data Sync</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Server Port</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database server port that is used to connect by the Data Sync</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Server Username</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database server username that is used to connect by the Data Sync</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Server Password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database server password that is used to connect by the Data Sync</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the database that is used to connect by the Data Sync</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use SSL?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use SSL connection to the SQL server</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Once the wizard steps are completed, navigate to the Project Overview in OpenShift to see the newly provisioned service.
Provisioning a service may take some time.</p>
</div>
<div class="paragraph">
<p>Once the provision is completed, you should be able to see it in the Mobile Developer Console: go to the Mobile Developer Console and click on any mobile client, and you should see the newly provisioned Data Sync server in the <code>Unbound Services</code> section. If you want your client app to use the Data Sync server, just click on <code>Bind To App</code> button and complete the wizard. Once it&#8217;s bound, copy the updated <code>mobile-services.json</code> file to your client app and you can then initialise the Data Sync client SDK.</p>
</div>
</div>
<div class="sect2">
<h3 id="sync-server-provisioning-data-sync-templates"><a class="anchor" href="#sync-server-provisioning-data-sync-templates"></a>Provisioning the Data Sync server applications using templates</h3>
<div class="paragraph">
<p>Data Sync offers following OpenShift templates
that will help developers with provisioning their DataSync applications to OpenShift platform.</p>
</div>
<div class="paragraph">
<p>Templates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DataSync App</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The DataSync App template allows developers to deploy the Node.js DataSync App on Openshift using source code only.  <em>Node s2i</em>  is used to build the DataSync App image.</p>
</div>
<div class="paragraph">
<p>The DataSync App can connect with other services running on OpenShift and can also connect to external data sources.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DataSync Showcase</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Showcase application will deploy fully functional server with example Task implementation.
Server side requires client application available on github <a href="https://github.com/aerogear/ionic-showcase">aerogear/ionic-showcase</a></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: Showcase server template can be used only for demo purposes and it should not be used in production.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>When running on Red Hat Managed Integration templates will be available in <strong>Mobile</strong> &gt; <strong>App</strong>  category in OpenShift catalog</p>
</div>
<div class="paragraph">
<p>Templates along with documentation can be found in <a href="https://github.com/aerogear/datasync-deployment">datasync-deployment</a> repository.</p>
</div>
</div>
<div class="sect2">
<h3 id="sync-server-getting-started-mdc-client"><a class="anchor" href="#sync-server-getting-started-mdc-client"></a>Connecting a Client</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to an OpenShift cluster with the Service Catalog.</p>
</li>
<li>
<p>You have completed the OpenShift getting started guide.</p>
</li>
<li>
<p>You have created a mobile client and bound your data sync server.</p>
</li>
<li>
<p>You have completed the client getting started guide.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once a service is bound to a mobile client, MDC will provide a mobile-services.json file that is used by the AeroGear client libraries to automatically configure the Data Sync client.  It is very important that you use your version of this file and not the one used in this example as system specific values will be different.</p>
</div>
<div class="sect3">
<h4 id="updating-the-hello-world-sync-client"><a class="anchor" href="#updating-the-hello-world-sync-client"></a>Updating the Hello World Sync Client</h4>
<div class="paragraph">
<p>The Hello World client application we wrote uses a hard coded server url.  We need to remove this url and instead pass the mobile-services config to the client.  We will also use the AeroGear core library to parse this file and pass that configuration to the Data Sync library.</p>
</div>
<div class="listingblock">
<div class="title">Configure the core library with mobile-services.json</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { init }  = require("@aerogear/app");

const core = init({
  "version": 1,
  "namespace": "myproject",
  "clientId": "getting-started",
  "services": [
    {
      "id": "0637bfd3-33aa-11e9-968e-52540014a8c2",
      "name": "sync-app-getting-started-getting-started",
      "type": "sync-app",
      "url": "https://sync-app-getting-started-myproject.192.168.42.138.nip.io/graphql",
      "config": {
        "websocketUrl": "wss://sync-app-getting-started-myproject.192.168.42.138.nip.io/graphql"
      }
    }
  ]
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have initialized the core, we can use it to configure the Data Sync client by setting the <code>openShiftConfig</code> property when we call <code>createClient</code>.</p>
</div>
<div class="listingblock">
<div class="title">Updated data sync client</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">let client = await createClient({
    openShiftConfig:core.config
  });</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now, as before, we can use the client to make queries.  A full example may look like the following code</p>
</div>
<div class="listingblock">
<div class="title">Updated hello world index.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import gql from 'graphql-tag';
const { init }  = require("@aerogear/app");
import { createClient } from '@aerogear/voyager-client';

const core = init({
  "version": 1,
  "namespace": "myproject",
  "clientId": "getting-started",
  "services": [
    {
      "id": "0637bfd3-33aa-11e9-968e-52540014a8c2",
      "name": "sync-app-getting-started-getting-started",
      "type": "sync-app",
      "url": "https://sync-app-getting-started-myproject.192.168.42.138.nip.io/graphql",
      "config": {
        "websocketUrl": "wss://sync-app-getting-started-myproject.192.168.42.138.nip.io/graphql"
      }
    }
  ]
});

async function helloWorld() {
  let client = await createClient({
    openShiftConfig:core.config
  });
  client.query({
      fetchPolicy: 'network-only',
      query: gql`{hello}`
    })
    .then( ({data}) =&gt; {
      console.log(data.hello)
    });
}

helloWorld();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sync-server-binding"><a class="anchor" href="#sync-server-binding"></a>Binding a Mobile App with the Data Sync server application service</h3>
<div class="paragraph">
<p>To use Mobile Services, you must represent your mobile app in <strong>Mobile Developer Console</strong>, and that app must be associated with the mobile service.
This association is called <strong>binding</strong> and it is necessary for your mobile app to use that service.</p>
</div>
<div class="paragraph">
<p>To bind a Mobile App with a mobile service:</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Launch Mobile Developer Console</p>
</li>
<li>
<p>Click on the Mobile App on the Overview screen</p>
</li>
<li>
<p>Navigate to <strong>Mobile Services</strong> tab.</p>
<div class="imageblock">
<div class="content">
<img src="_images/mobile-clients-services-all-unbound.png" alt="mobile clients services all unbound">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is possible to bind a Mobile App with a mobile service in the OpenShift console, however such bindings are not valid for the purposes of this procedure.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Press <strong>Bind to App</strong> in the Data Sync</p>
</li>
<li>
<p>Fill out the binding parameters required by the Data Sync Service.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="sync-server-binding-keycloak"><a class="anchor" href="#sync-server-binding-keycloak"></a>Binding Data Sync to Identity Management</h3>
<div class="paragraph">
<p>In this section, we will show you how to protect your Data Sync application using the Identity Management service.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>There is a Identity Management service available.</p>
</li>
<li>
<p>You have provisioned a Data Sync application using our playbook.</p>
</li>
<li>
<p>oc tools must be installed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any application that connects to Identity Management must consume a <code>keycloak.json</code> file. This section demonstrates how to add a <code>keycloak.json</code> file to your Data Sync application deployment. It is still your application&#8217;s responsibility to consume this file. We have provided an <a href="https://github.com/aerogear/voyager-server/tree/master/examples/keycloak">example project</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a client for your application in the Identity Management Administration Console</p>
</li>
<li>
<p>Click on the <code>Installation</code> tab, select <code>Keycloak OIDC JSON</code> for <code>Format</code> Option, and then click on <code>Download</code>. Save the downloaded <code>keycloak.json</code>.</p>
</li>
<li>
<p>Create a Identity Management secret:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create secret generic sync-keycloak-doc \
  --from-file=keycloak=./keycloak.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command creates a secret named <code>sync-keycloak-doc</code>.</p>
</div>
<div class="paragraph">
<p>The secret will contain one key, <code>keycloak</code>, with the value being the text of the <code>keycloak.json</code> file.</p>
</div>
<div class="paragraph">
<p>You can view the secret with either <code>oc get secret sync-keycloak-doc</code> or the OpenShift web console.</p>
</div>
</li>
<li>
<p>Create a patch for your deployment configuration</p>
<div class="paragraph">
<p>This step requires patching the Data Sync application&#8217;s deployment config to create and mount a volume with the Identity Management secret we just created. Replace <code>$YOUR_DEPLOYMENT_CONFIG_NAME</code> in the following yaml section with the deployment config name of your Data Sync application and save this file as <code>secret.yaml</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  template:
    spec:
      containers:
        - env:
          - name: KEYCLOAK_CONFIG
            value: /config/keycloak.json
          name: $YOUR_DEPLOYMENT_CONFIG_NAME
          volumeMounts:
            - name: secret-volume
              mountPath: /config
              readOnly: true
      volumes:
          - name: secret-volume
            secret:
              items:
                - key: keycloak
                  path: keycloak.json
              secretName: sync-keycloak-doc</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the patch.</p>
<div class="paragraph">
<p>After replacing <code>$YOUR_DEPLOYMENT_CONFIG_NAME</code> with the deployment config name, run the following command to patch the deployment configuration and trigger your application to redeploy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc patch deploymentconfig $YOUR_DEPLOYMENT_CONFIG_NAME -p "$(cat secret.yaml)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once your application has redeployed, it should be able to read the keycloak.json file pointed to by the KEYCLOAK_CONFIG environment variable.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sync-sample-app"><a class="anchor" href="#sync-sample-app"></a>Showcase App</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/aerogear/ionic-showcase">sample application</a> demonstrates features offered by the Data Sync framework, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GraphQL Schema</p>
</li>
<li>
<p>Offline Storage</p>
</li>
<li>
<p>Conflict Resolution</p>
</li>
<li>
<p>Subscriptions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the <a href="showcase-apps.html" class="page">Showcase Apps section</a> for instructions about how to run it.</p>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <div class="container">
    <div class="row">

      <div class="col-sm-4">
        <h5>Mobile Services</h5>
        <ul class="list-unstyled">
         <li><a href="https://aerogear.org/services/identity-management/">Identity Management</a></li>
         <li><a href="https://aerogear.org/services/push/">Push Notifications</a></li>
         <li><a href="https://aerogear.org/services/metrics/">Mobile Metrics</a></li>
         <li><a href="https://aerogear.org/services/mobile-ci-cd/">Mobile CI/CD</a></li>
         <li><a href="https://aerogear.org/services/device-security/">Device Security</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-4">
        <h5>Mobile SDKs</h5>
        <ul class="list-unstyled">
         <li><a href="https://aerogear.org/sdks/android/">Android</a></li>
         <li><a href="https://aerogear.org/sdks/cordova/">Cordova</li>
         <li><a href="https://aerogear.org/sdks/ios/">iOS</a></li>
         <li><a href="https://aerogear.org/sdks/xamarin/">Xamarin</a></li>
        </ul>
      </div><!-- col -->
      
      <div class="col-sm-4">
        <h5>COMMUNITY</h5>
        <ul class="list-unstyled">
          <li><a target="_blank" href="https://github.com/aerogear/">GitHub - Aerogear</a></li>
          <li><a target="_blank" href="https://github.com/aerogearcatalog/">GitHub - Aerogear Catalog</a></li>
          <li><a target="_blank" href="https://issues.jboss.org/browse/AEROGEAR">Jira Repo Issues</a></li>
          <li><a  href="https://aerogear.org/community/contribution-guide/">Contribution Guide</a></li>
          <li><a target="_blank" href="https://groups.google.com/forum/#!forum/aerogear">Google Group</a></li>
          <li><a href="irc://irc.freenode.net/aerogear">IRC</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-12 follow">
        <h5>FOLLOW US</h5>
        <ul class="list-inline">
          <li><a target="_blank" href="https://www.twitter.com/aerogears"><i class="fa fa-twitter-square"></i> Twitter</a></li>
          <li><a target="_blank" href="https://www.youtube.com/channel/UCgDcDoN2b7cEI63fgpxACBA"><i class="fa fa-youtube"></i> YouTube</a></li>
          <li><a target="_blank" href="https://aerogear.org/news"><i class="fa fa-rss-square"></i> Feed</a></li>
        </ul>
        
        <p>The AeroGear project is licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>, and is subject to the <a href="https://aerogear.org/legal/export.html">Export Policy</a>.</p>
      </div><!-- col -->
    
    </div><!-- row -->

  </div><!-- container -->

</footer><!-- footer -->

<section class="redhat">
  <div class="container">
    <p class="text-center">
      <a href="http://www.redhat.com/">
        <img src="/_/img/redhatlogo-wite.png" alt="redhatlogo-wite" width="130">
      </a>
    </p>       
  </div><!-- container -->
</section>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
