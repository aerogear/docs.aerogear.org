<!DOCTYPE html>
<html lang="en">
  <head>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-8+rznmq/k0KZkJlZhnuPEVkbRD7tA0wcFEjY48dajGWn3Xc1MasJwS8/tJ7OEsKW" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-1.9.1.min.js" integrity="sha256-wS9gmOZBqsqWxgIVgA8Y9WcQOa7PgSIX+rPA0VL2rbQ=" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" integrity="sha384-Nud2SriDt2fZ+u85IBC48Yn9p+l4AGlapnX1EGA2KrnZjYJx8sxKnw/CIxc1wU1B" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-url/2.5.3/url.js"></script>
<script>
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	item.on('click', '', content, function(e) {
		$(this).addClass('selected');
		$(this).siblings().removeClass('selected');
		e.data.siblings('.content').addClass('hidden');
		e.data.removeClass('hidden');
	});
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

$(addBlockSwitches);

Zepto(function($){
	if (url('?header') === 'false') {
		// Hide the navbar for showcase apps (#nochrome)
		$('body').addClass('nochrome');
	}
})
</script>


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Developer Security Guide :: AeroGear Mobile Services</title>
    <link rel="canonical" href="https://docs.aerogear.org/mobile-security/latest/androidDeveloperSecurityGuide.html">
    <meta name="generator" content="Antora 1.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.png" type="image/x-icon">
  </head>
  <body class="article">
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">AeroGear</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        <li>
          <a href="https://aerogear.org">Home</a>
        </li>

        <li>
          <a href="https://aerogear.org/getting-started/">Getting Started</a>
        </li>

        <li>
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Mobile Services<span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
              <li>
                <a href="https://aerogear.org/services/identity-management/">
                  <i class="material-icons" aria-hidden="true">account_circle</i> Identity Management
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/push/">
                  <i class="material-icons" aria-hidden="true">notifications_active</i> Push Notifications
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/runtime-connector/">
                  <i class="material-icons" aria-hidden="true">cloud</i> Runtime Connector
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/metrics/">
                  <i class="material-icons" aria-hidden="true">insert_chart</i> Mobile Metrics
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/mobile-ci-cd/">
                  <i class="material-icons" aria-hidden="true">build</i> Mobile CI/CD
                </a>
              </li>
              <li>
                <a href="https://aerogear.org/services/device-security/">
                  <i class="material-icons" aria-hidden="true">security</i> Device Security
                </a>
              </li>
            </ul>
        </li>

        <li>
          <a href="https://aerogear.org/sdks">Mobile SDKs</a>
        </li>

        <li class="hidden-sm active">
          <a href="https://docs.aerogear.org">Docs</a>
        </li>
   
        <li>
          <a href="https://aerogear.org/community">Community</a>
        </li>
        

        <li>
          <a href="https://aerogear.org/news">News</a>
        </li>
        
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav><div class="main-wrapper">
<div class="navigation-container" data-component="mobile-security" data-version="latest">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Mobile Security</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="index.html#aerogear-mobile-security">Recommendations Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#authentication-session-management">Authentication and Session Management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#data-storage-summary">Data Storage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#network-security">Network</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#mobile-app-self-defence">Mobile App Defense</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#handling-sensitive-data-overview">Sensitive Data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#cryptography-summary">Cryptography</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="references.html">References</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="owaspTopMobileRisks.html">OWASP Top 10 Mobile Risks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobileSecurityRequirements.html">Mobile Application Security Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="owaspMobileDevelopmentGuidelines.html">Secure Mobile Development Guidelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="owaspCheatSheetSeries.html">OWASP Cheat Sheet Series</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="owaspMobileVerificationStandard.html">OWASP Mobile Verification Standard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="owaspMobileThreatModelProject.html">OWASP Threat Model Project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="owaspMobileMTools.html">OWASP M-Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="iosSecurityGuide.html">iOS Security Whitepaper</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="androidSecurityGuide.html">Android Security Guide</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="androidDeveloperSecurityGuide.html">Android Developer Security Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cordovaSecurityGuide.html">Cordova Security Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="nispMobileSecurityVetting.html">Vetting the Security of Mobile Applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="niapMobileAppVetting.html">NIAP Mobile App Vetting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="dhsMobileDeviceSecurity.html">DHS Study on Mobile Device Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="nispMobileDeviceSecurityGuides.html">Guidelines for Managing the Security of Mobile Devices in the Enterprise</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobileBankingSecurity.html">Mobile Banking Applications Security Challenges</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mobileSecureDevelopmentGuide.html">Secure Mobile Development Guide</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Mobile Security</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Mobile Security</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Mobile Services</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../aerogear/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../../aerogear/latest/getting-started.html" class="home-link"></a>
<nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Mobile Security</a></li>
    <li class="crumb"><a href="references.html">References</a></li>
    <li class="crumb"><a href="androidDeveloperSecurityGuide.html">Android Developer Security Guide</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/aerogear/mobile-security/edit/master/modules/ROOT/pages/androidDeveloperSecurityGuide.adoc"></a></div>
</div>
<article class="doc">
<h1>Android Developer Security Guide</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This is a summary of the <a href="https://developer.android.com/training/best-security.html">Android Developer Security Guide</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following core security features help you build secure apps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Android Application Sandbox, which isolates your app data and code execution from other apps.</p>
</li>
<li>
<p>An application framework with robust implementations of common security functionality such as cryptography, permissions, and secure IPC.</p>
</li>
<li>
<p>Technologies like ASLR, NX, ProPolice, safe_iop, OpenBSD dlmalloc, OpenBSD calloc, and Linux mmap_min_addr to mitigate risks associated with common memory management errors.</p>
</li>
<li>
<p>An encrypted file system that can be enabled to protect data on lost or stolen devices.</p>
</li>
<li>
<p>User-granted permissions to restrict access to system features and user data.</p>
</li>
<li>
<p>Application-defined permissions to control application data on a per-app basis.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="data-storage"><a class="anchor" href="#data-storage"></a>Data Storage</h3>
<div class="paragraph">
<p>The most common security concern for an application on Android is whether the data that you save on the device is accessible to other apps.</p>
</div>
<div class="paragraph">
<p>There are three fundamental ways to save data on the device:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Internal Storage</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>By default, files that you create on internal storage are accessible only to your app. Android implements this protection, and it&#8217;s sufficient for most applications.</p>
</li>
<li>
<p>Avoid the <code>MODE_WORLD_WRITEABLE</code> or <code>MODE_WORLD_READABLE</code> modes for IPC files because they do not provide the ability to limit data access to particular applications, nor do they provide any control of data format. If you want to share your data with other app processes, instead consider using a content provider, which offers read and write permissions to other apps and can make dynamic permission grants on a case-by-case basis.</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>External Storage</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Files created on external storage, such as SD cards, are globally readable and writable. Because external storage can be removed by the user and also modified by any application, don&#8217;t store sensitive information using external storage.</p>
</li>
<li>
<p>You should Perform input validation when handling data from external storage as you would with data from any untrusted source. You should not store executables or class files on external storage prior to dynamic loading. If your app does retrieve executable files from external storage, the files should be signed and cryptographically verified prior to dynamic loading.</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Content Providers</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Content providers offer a structured storage mechanism that can be limited to your own application or exported to allow access by other applications.
If you do not intend to provide other applications with access to your ContentProvider, mark them as <code>android:exported=false</code> in the application manifest.
Otherwise, set the <code>android:exported</code> attribute to true to allow other apps to access the stored data.</p>
</li>
<li>
<p>If you are using a content provider for sharing data between only your own apps, it is preferable to use the <code>android:protectionLevel</code> attribute set to signature protection.
Signature permissions do not require user confirmation, so they provide a better user experience and more controlled access to the content provider data when the apps accessing the data are signed with the same key.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="permissions"><a class="anchor" href="#permissions"></a>Permissions</h3>
<div class="paragraph">
<p>Android permissions are ranked in four different categories based on the protection level they offer:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Normal: the lower level of protection. It gives the apps access to isolated application-level feature, with minimal risk to other apps, the user or the system. It is granted during the installation of the App. It is also the default value for the cases when no protection level is specified. Example: <code>android.permission.INTERNET</code></p>
</li>
<li>
<p>Dangerous: This permission usually gives the app control over the user data or over the device that impacts the user. This type of permission may not be granted at installation time, leaving it to the user to decide whether the app should have the permission or not. Example: <code>android.permission.RECORD_AUDIO</code></p>
</li>
<li>
<p>Signature: This permission is granted only if the requesting app was signed with the same certificate as the app that declared the permission. If the signature matches, the permission is automatically granted. Example: <code>android.permission.ACCESS_MOCK_LOCATION</code></p>
</li>
<li>
<p>SystemOrSignature: Permission only granted to the apps embedded in the system image or that were signed using the same certificated as the app that declared the permission. Example: <code>android.permission.ACCESS_DOWNLOAD_MANAGER</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="ip-networking"><a class="anchor" href="#ip-networking"></a>IP Networking</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You should use HTTPS over HTTP anywhere that HTTPS is supported on the server, because mobile devices frequently connect on networks that are not secured, such as public Wi-Fi hotspots.
Authenticated, encrypted socket-level communication can be easily implemented using the <a href="https://developer.android.com/reference/javax/net/ssl/SSLSocket.html">SSLSocket class</a>.</p>
</li>
<li>
<p>Some applications use localhost network ports for handling sensitive IPC.
You should not use this approach because these interfaces are accessible by other applications on the device.
Instead, use an Android IPC mechanism where authentication is possible, such as with a Service.
Binding to <code>INADDR_ANY</code> is worse than using loopback because then your application may receive requests from anywhere.</p>
</li>
<li>
<p>Make sure that you don&#8217;t trust data downloaded from HTTP or other insecure protocols. This includes validation of input in WebView and any responses to intents issued against HTTP.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="telephony-networking"><a class="anchor" href="#telephony-networking"></a>Telephony Networking</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Beware that SMS is neither encrypted nor strongly authenticated on either the network or the device. In particular, any SMS receiver should expect that a malicious user may have sent the SMS to your application.
Don&#8217;t rely on unauthenticated SMS data to perform sensitive commands.</p>
</li>
<li>
<p>Also, you should be aware that SMS may be subject to spoofing and/or interception on the network. On the Android-powered device itself, SMS messages are transmitted as broadcast intents, so they may be read or captured by other applications that have the <code>READ_SMS</code> permission.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="input-validation"><a class="anchor" href="#input-validation"></a>Input Validation</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Insufficient input validation is one of the most common security problems affecting applications, regardless of what platform they run on.
Android has platform-level countermeasures that reduce the exposure of applications to input validation issues, and you should use those features where possible.</p>
</li>
<li>
<p>If you are using native code, any data read from files, received over the network, or received from an IPC has the potential to introduce a security issue. The most common problems are <a href="http://en.wikipedia.org/wiki/Buffer_overflow">buffer overflows</a>, <a href="http://en.wikipedia.org/wiki/Double_free#Use_after_free">use after free</a>, and <a href="http://en.wikipedia.org/wiki/Off-by-one_error">off-by-one errors</a>.
Android provides a number of technologies like ASLR and DEP that reduce the exploitability of these errors, but they don&#8217;t solve the underlying problem. You can prevent these vulnerabilities by carefully handling pointers and managing buffers.</p>
</li>
<li>
<p>If you are using data within queries that are submitted to an SQL database or a content provider, SQL injection may be an issue. The best defense is to use parameterized queries, as is discussed in the above section about content providers. Limiting permissions to read-only or write-only can also reduce the potential for harm related to SQL injection.</p>
</li>
<li>
<p>You should make sure to use well-structured data formats and verify that the data conforms to the expected format. While blacklisting of characters or character-replacement can be an effective strategy, these techniques are error prone in practice and should be avoided when possible.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="handling-user-data"><a class="anchor" href="#handling-user-data"></a>Handling User Data</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In general, the best approach for user data security is to minimize the use of APIs that access sensitive or personal user data. If you have access to user data and can avoid storing or transmitting it, don&#8217;t store or transmit the data.</p>
</li>
<li>
<p>Consider if there is a way that your application logic can be implemented using a hash or non-reversible form of the data.</p>
</li>
<li>
<p>For example, your application might use the hash of an email address as a primary key to avoid transmitting or storing the email address. This reduces the chances of inadvertently exposing data, and it also reduces the chance of attackers attempting to exploit your application.</p>
</li>
<li>
<p>If your app requires access to sensitive data, evaluate whether you need to transmit it to a server or you can run the operation on the client. Consider running any code using sensitive data on the client to avoid transmitting user data.</p>
</li>
<li>
<p>Also, make sure that you do not inadvertently expose user data to other applications on the device through overly permissive IPC, world-writable files, or network sockets. Overly permissive IPC is a special case of leaking permission-protected data.</p>
</li>
<li>
<p>If a GUID is required, create a large, unique number and store it. Don&#8217;t use phone identifiers such as the phone number or IMEI, which may be associated with personal information.</p>
</li>
<li>
<p>Be careful when writing to on-device logs. In Android, logs are a shared resource and are available to an application with the <code>READ_LOGS</code> permission.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="using-webviews"><a class="anchor" href="#using-webviews"></a>Using Webviews</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Because WebView consumes web content that can include HTML and JavaScript, improper use can introduce common web security issues such as XSS.
Android includes a number of mechanisms to reduce the scope of these potential issues by limiting the capability of WebView to the minimum functionality required by your application</p>
</li>
<li>
<p>If your application doesn&#8217;t directly use JavaScript within a WebView, do not call <code>setJavaScriptEnabled()</code>. By default, WebView does not execute JavaScript, so XSS is not possible.</p>
</li>
<li>
<p>If your application accesses sensitive data with a WebView, you may want to use the <code>clearCache()</code> method to delete any files stored locally. You can also use server-side headers such as <code>no-cache</code> to indicate that an application should not cache particular content.</p>
</li>
<li>
<p>Use <code>addJavaScriptInterface()</code> with particular care because it allows JavaScript to invoke operations that are normally reserved for Android applications. If you use it, expose <code>addJavaScriptInterface()</code> only to web pages from which all input is trustworthy.
In general, the Android documentation recommends exposing <code>addJavaScriptInterface()</code> only to JavaScript that is contained within your application APK.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="handling-credentials"><a class="anchor" href="#handling-credentials"></a>Handling Credentials</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To make phishing attacks more conspicuous and less likely to be successful, minimize the frequency of asking for user credentials. Instead use an authorization token and refresh it.</p>
</li>
<li>
<p>Where possible, don&#8217;t store user names and passwords on the device. Instead, perform initial authentication using the user name and password supplied by the user, and then use a short-lived, service-specific authorization token.</p>
</li>
<li>
<p>Services that are accessible to multiple applications should be accessed using AccountManager. If possible, use the AccountManager class to invoke a cloud-based service and don&#8217;t store passwords on the device.</p>
</li>
<li>
<p>After using AccountManager to retrieve an Account, use <a href="https://developer.android.com/reference/android/accounts/Account.html#CREATOR">CREATOR</a> before passing in any credentials so that you do not inadvertently pass credentials to the wrong application.</p>
</li>
<li>
<p>If credentials are used only by applications that you create, you can verify the application that accesses the AccountManager using <code>checkSignature()</code>. Alternatively, if only one application uses the credential, you might use a KeyStore for storage.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="cryptography"><a class="anchor" href="#cryptography"></a>Cryptography</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use a secure random number generator, SecureRandom, to initialize any cryptographic keys generated by KeyGenerator. Use of a key that is not generated with a secure random number generator significantly weakens the strength of the algorithm and may allow offline attacks.</p>
</li>
<li>
<p>If you need to store a key for repeated use, use a mechanism, such as KeyStore, that provides a mechanism for long term storage and retrieval of cryptographic keys.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="ipc"><a class="anchor" href="#ipc"></a>IPC</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Some apps attempt to implement IPC using traditional Linux techniques such as network sockets and shared files.
However, you should instead use Android system functionality for IPC such as <a href="https://developer.android.com/reference/android/content/Intent.html">Intent</a>, <a href="https://developer.android.com/reference/android/os/Binder.html">Binder</a> or <a href="https://developer.android.com/reference/android/os/Messenger.html">Messenger</a> with a <a href="https://developer.android.com/reference/android/app/Service.html">Service</a>, and <a href="https://developer.android.com/reference/android/content/BroadcastReceiver.html">BroadcastReceiver</a>.
The Android IPC mechanisms allow you to verify the identity of the application connecting to your IPC and set a security policy for each IPC mechanism.</p>
</li>
<li>
<p>Many of the security elements are shared across IPC mechanisms. If your IPC mechanism is not intended for use by other applications, set the <code>android:exported</code> attribute to <code>false</code> in the component&#8217;s manifest element.</p>
</li>
<li>
<p>If your IPC is accessible to other applications, you can apply a security policy by using the <code>&lt;permission&gt;</code> element.
If IPC is between your own separate apps that are signed with the same key, it is preferable to use signature level permission in the <code>android:protectionLevel</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="intents"><a class="anchor" href="#intents"></a>Intents</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For activities and broadcast receivers, intents are the preferred mechanism for asynchronous IPC in Android. Depending on your application requirements, you might use <a href="https://developer.android.com/reference/android/content/Context.html#sendBroadcast(android.content.Intent)">sendBroadcast()</a>, <a href="https://developer.android.com/reference/android/content/Context.html#sendOrderedBroadcast">sendOrderedBroadcast()</a>, or an explicit intent to a specific application component. For security purposes, explicit intents are preferred.</p>
</li>
<li>
<p>If you use an intent to bind to a Service, ensure that your app is secure by using an explicit intent. Using an implicit intent to start a service is a security hazard because you can&#8217;t be certain what service will respond to the intent, and the user can&#8217;t see which service starts.</p>
</li>
<li>
<p>Senders of an intent can verify that the recipient has permission by specifying a non-null permission with the method call. Only applications with that permission receive the intent. If data within a broadcast intent may be sensitive, you should consider applying a permission to make sure that malicious applications can&#8217;t register to receive those messages without appropriate permissions. In those circumstances, you may also consider invoking the receiver directly, rather than raising a broadcast.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="services"><a class="anchor" href="#services"></a>Services</h3>
<div class="paragraph">
<p>A Service is often used to supply functionality for other applications to use. Each service class must have a corresponding <code>&lt;service&gt;</code> declaration in its manifest file.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>By default, services are not exported and cannot be invoked by any other application. However, if you add any intent filters to the service declaration, it is exported by default.
It&#8217;s best if you explicitly declare the <code>android:exported</code> attribute to be sure it behaves as you&#8217;d like. Services can also be protected using the <code>android:permission attribute</code>.
By doing so, other applications need to declare a corresponding <code>&lt;uses-permission&gt;</code> element in their own manifest to be able to start, stop, or bind to the service.</p>
</li>
<li>
<p>If your app targets Android 5.0 (API level 21) or later, you should use the <a href="https://developer.android.com/reference/android/app/job/JobScheduler.html">JobScheduler</a> to execute background services.</p>
</li>
<li>
<p>A service can protect individual IPC calls into it with permissions, by calling <code>checkCallingPermission()</code> before executing the implementation of that call.
You should use the declarative permissions in the manifest, since those are less prone to oversight.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="binder-and-messenger-interfaces"><a class="anchor" href="#binder-and-messenger-interfaces"></a>Binder and Messenger Interfaces</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using <a href="https://developer.android.com/reference/android/os/Binder.html">Binder</a> or <a href="https://developer.android.com/reference/android/os/Messenger.html">Messenger</a> is the preferred mechanism for RPC-style IPC in Android.
They provide a well-defined interface that enables mutual authentication of the endpoints, if required.</p>
</li>
<li>
<p>If you are providing an interface that does require access controls, use <a href="https://developer.android.com/reference/android/content/Context.html#checkCallingPermission(java.lang.String)">checkCallingPermission()</a> to verify whether the caller has a required permission.
This is especially important before accessing a service on behalf of the caller, as the identify of your application is passed to other interfaces.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="broadcast-receivers"><a class="anchor" href="#broadcast-receivers"></a>Broadcast Receivers</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A BroadcastReceiver handles asynchronous requests initiated by an Intent.</p>
</li>
<li>
<p>By default, receivers are exported and can be invoked by any other application. If your BroadcastReceiver is intended for use by other applications, you may want to apply security permissions to receivers using the <code>&lt;receiver&gt;</code> element within the application manifest.
This prevents applications without appropriate permissions from sending an intent to the BroadcastReceiver.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="dynamically-loading-code"><a class="anchor" href="#dynamically-loading-code"></a>Dynamically Loading Code</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Loading code from outside of your application APK significantly increases the likelihood of application compromise due to code injection or code tampering.</p>
</li>
<li>
<p>If your application does dynamically load code, the most important thing to keep in mind about dynamically-loaded code is that it runs with the same security permissions as the application APK.</p>
</li>
<li>
<p>The major security risk associated with dynamically loading code is that the code needs to come from a verifiable source.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="virtual-machine-security"><a class="anchor" href="#virtual-machine-security"></a>Virtual Machine Security</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Dalvik is Android&#8217;s runtime virtual machine (VM). Your application runs in a secure sandbox environment, so other processes on the system can&#8217;t access your code or private data.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security-with-https-and-ssl"><a class="anchor" href="#security-with-https-and-ssl"></a>Security with HTTPS and SSL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is a summary of the <a href="https://developer.android.com/training/articles/security-ssl.html">Android Developer Security with HTTPS and SSL Guide</a>.</p>
</div>
<div class="paragraph">
<p>The Secure Sockets Layer (SSL)—now technically known as Transport Layer Security (TLS)—is a common building block for encrypted communications between clients and servers.
It&#8217;s possible that an application might use SSL incorrectly such that malicious entities may be able to intercept an app&#8217;s data over the network.</p>
</div>
<div class="paragraph">
<p>As of Android 4.2 (Jelly Bean), Android currently contains over 100 CAs that are updated in each release. Similar to a server, a CA has a certificate and a private key. When issuing a certificate for a server, the CA signs the server certificate using its private key. The client can then verify that the server has a certificate issued by a CA known to the platform.</p>
</div>
<div class="sect2">
<h3 id="https-example"><a class="anchor" href="#https-example"></a>HTTPS Example</h3>
<div class="paragraph">
<p>Assuming you have a web server with a certificate issued by a well known CA, you can make a secure request with code as simple this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>URL url = new URL("https://wikipedia.org");
URLConnection urlConnection = url.openConnection();
InputStream in = urlConnection.getInputStream();
copyInputStreamToOutputStream(in, System.out);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Suppose instead of receiving the content from <code>getInputStream()</code>, it throws an exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>javax.net.ssl.SSLHandshakeException: java.security.cert.CertPathValidatorException: Trust anchor for certification path not found.</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can happen for several reasons, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Unknown CA</strong> - The CA that issued the server certificate was unknown.</p>
<div class="ulist">
<ul>
<li>
<p>In this case, the <code>SSLHandshakeException</code> occurs because you have a CA that isn&#8217;t trusted by the system. It could be because you have a certificate from a new CA that isn&#8217;t yet trusted by Android or your app is running on an older version without the CA. More often a CA is unknown because it isn&#8217;t a public CA, but a private one issued by an organization such as a government, corporation, or education institution for their own use. With a custom TrustManager that knows about your CAs, the system is able to validate that your server certificate come from a trusted issuer.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Self-Signed Server Certificate</strong> - The server certificate wasn&#8217;t signed by a CA, but was self signed.</p>
<div class="ulist">
<ul>
<li>
<p>The second case of <code>SSLHandshakeException</code> is due to a self-signed certificate, which means the server is behaving as its own CA. As before, you can create your own TrustManager, this time trusting the server certificate directly.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Missing Intermediate CA</strong> - The server configuration is missing an intermediate CA.</p>
<div class="ulist">
<ul>
<li>
<p>The third case of <code>SSLHandshakeException</code> occurs due to a missing intermediate CA. Most public CAs don&#8217;t sign server certificates directly. Instead, they use their main CA certificate, referred to as the root CA, to sign intermediate CAs. They do this so the root CA can be stored offline to reduce risk of compromise.</p>
</li>
<li>
<p>However, operating systems like Android typically trust only root CAs directly, which leaves a short gap of trust between the server certificate—signed by the intermediate CA—and the certificate verifier, which knows the root CA.</p>
</li>
<li>
<p>To solve this, the server doesn&#8217;t send the client only it&#8217;s certificate during the SSL handshake, but a chain of certificates from the server CA through any intermediates necessary to reach a trusted root CA.</p>
</li>
<li>
<p>There are two approaches to solve this issue:</p>
<div class="ulist">
<ul>
<li>
<p>Configure the server to include the intermediate CA in the server chain. Most CAs provide documentation on how to do this for all common web servers. This is the only approach if you need the site to work with default Android browsers at least through Android 4.2.</p>
</li>
<li>
<p>Or, treat the intermediate CA like any other unknown CA, and create a TrustManager to trust it directly, as done in the previous two sections.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="hostname-verification"><a class="anchor" href="#hostname-verification"></a>Hostname verification</h3>
<div class="paragraph">
<p>There are two key parts to verifying an SSL connection:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The first is to verify the certificate is from a trusted source, which was the focus of the previous section.</p>
</li>
<li>
<p>The second part is making sure the server you are talking to presents the right certificate. When it doesn&#8217;t, you&#8217;ll typically see an error like this:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>java.io.IOException: Hostname 'example.com' was not verified
at libcore.net.http.HttpConnection.verifySecureSocketHostname(HttpConnection.java:223)
at libcore.net.http.HttpsURLConnectionImpl$HttpsEngine.connect(HttpsURLConnectionImpl.java:446)</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>One reason this can happen is due to a server configuration error.
The server is configured with a certificate that does not have a subject or subject alternative name fields that match the server you are trying to reach. It is possible to have one certificate be used with many different servers.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="warnings-about-using-sslsocket-directly"><a class="anchor" href="#warnings-about-using-sslsocket-directly"></a>Warnings About Using SSLSocket Directly</h3>
<div class="paragraph">
<p><a href="https://developer.android.com/reference/javax/net/ssl/SSLSocket.html">SSLSocket</a> does not perform hostname verification. It is up the your app to do its own hostname verification, preferably by calling <code>getDefaultHostnameVerifier()</code> with the expected hostname. Further beware that <code>HostnameVerifier.verify()</code> doesn&#8217;t throw an exception on error but instead returns a boolean result that you must explicitly check.</p>
</div>
</div>
<div class="sect2">
<h3 id="blacklisting"><a class="anchor" href="#blacklisting"></a>Blacklisting</h3>
<div class="paragraph">
<p>SSL relies heavily on CAs to issue certificates to only the properly verified owners of servers and domains. In rare cases, CAs are either tricked or breached, resulting in the certificates for a hostname to be issued to someone other than the owner of the server or domain.</p>
</div>
<div class="paragraph">
<p>In order to mitigate this risk, Android has the ability to blacklist certain certificates or even whole CAs. While this list was historically built into the operating system, starting in Android 4.2 this list can be remotely updated to deal with future compromises.</p>
</div>
</div>
<div class="sect2">
<h3 id="pinning"><a class="anchor" href="#pinning"></a>Pinning</h3>
<div class="paragraph">
<p>An app can further protect itself from fraudulently issued certificates by a technique known as pinning. This prevents the compromise of one of the other 100+ CAs in the system from resulting in a breach of the apps secure channel.</p>
</div>
</div>
<div class="sect2">
<h3 id="client-certificates"><a class="anchor" href="#client-certificates"></a>Client Certificates</h3>
<div class="paragraph">
<p>SSL also supports the notion of client certificates that allow the server to validate the identity of a client.</p>
</div>
</div>
<div class="sect2">
<h3 id="nogotofail-a-network-traffic-security-testing-tool"><a class="anchor" href="#nogotofail-a-network-traffic-security-testing-tool"></a>Nogotofail: A Network Traffic Security Testing Tool</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://github.com/google/nogotofail">Nogotofail</a> is a tool gives you an easy way to confirm that your apps are safe against known TLS/SSL vulnerabilities and misconfigurations.
It&#8217;s an automated, powerful, and scalable tool for testing network security issues on any device whose network traffic could be made to go through it.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nogotofail is useful for three main use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Finding bugs and vulnerabilities.</p>
</li>
<li>
<p>Verifying fixes and watching for regressions.</p>
</li>
<li>
<p>Understanding what applications and devices are generating what traffic.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="network-security-configuration"><a class="anchor" href="#network-security-configuration"></a>Network Security Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is a summary of the <a href="https://developer.android.com/training/articles/security-ssl.html">Android Developer Network Security Configuration Guide</a>.</p>
</div>
<div class="sect2">
<h3 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h3>
<div class="paragraph">
<p>The Network Security Configuration feature lets apps customize their network security settings in a safe, declarative configuration file without modifying app code. These settings can be configured for specific domains and for a specific app. The key capabilities of this feature are as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Custom trust anchors</strong>: Customize which Certificate Authorities (CA) are trusted for an app&#8217;s secure connections. For example, trusting particular self-signed certificates or restricting the set of public CAs that the app trusts.</p>
</li>
<li>
<p><strong>Debug-only overrides</strong>: Safely debug secure connections in an app without added risk to the installed base.</p>
</li>
<li>
<p><strong>Cleartext traffic opt-out</strong>: Protect apps from accidental usage of cleartext traffic.</p>
</li>
<li>
<p><strong>Certificate pinning</strong>: Restrict an app&#8217;s secure connection to particular certificates.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Network Security Configuration feature uses an XML file where you specify the settings for your app. You must include an entry in the manifest of your app to point to this file.</p>
</div>
<div class="paragraph">
<p>Example reference of the network security settings from the applications manifest xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;manifest ... &gt;
    &lt;application android:networkSecurityConfig="@xml/network_security_config"
                    ... &gt;
        ...
    &lt;/application&gt;
&lt;/manifest&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customizing-trusted-cas"><a class="anchor" href="#customizing-trusted-cas"></a>Customizing Trusted CAs</h3>
<div class="paragraph">
<p>An app may want to trust a custom set of CAs instead of the platform default. The most common reasons of this are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connecting to a host with a custom certificate authority, such as a CA that is self-signed or is issued internally within a company.</p>
</li>
<li>
<p>Limiting the set of CAs to only the CAs you trust instead of every pre-installed CA.</p>
</li>
<li>
<p>Trusting additional CAs not included in the system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An app can customize its own connections using <code>base-config</code> (for app-wide customization) or <code>domain-config</code> (for per-domain customization).</p>
</div>
<div class="paragraph">
<p>For Configuring CA&#8217;s, configuration examples are available in the Android Documentation.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://developer.android.com/training/articles/security-config.html#ConfigCustom">Configuring a Custom CA</a></p>
</li>
<li>
<p><a href="https://developer.android.com/training/articles/security-config.html#LimitingCas">Limiting the Set of Trusted CAs</a></p>
</li>
<li>
<p><a href="https://developer.android.com/training/articles/security-config.html#TrustingAdditionalCas">Trusting Additional CAs</a></p>
</li>
<li>
<p><a href="http://developer.android.com/training/articles/security-config.html#TrustingDebugCa">Configuring CAs for Debugging</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="opting-out-of-cleartext-traffic"><a class="anchor" href="#opting-out-of-cleartext-traffic"></a>Opting Out of Cleartext Traffic</h3>
<div class="paragraph">
<p>Applications intending to connect to destinations using only secure connections can opt-out of supporting cleartext (using the unencrypted HTTP protocol instead of HTTPS) to those destinations. This option helps prevent accidental regressions in apps due to changes in URLs provided by external sources such as backend servers.</p>
</div>
<div class="paragraph">
<p>For example, an app may want to ensure that all connections to secure.example.com are always done over HTTPS to protect sensitive traffic from hostile networks.</p>
</div>
<div class="paragraph">
<p><strong>res/xml/network_security_config.xml</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;network-security-config&gt;
    &lt;domain-config cleartextTrafficPermitted="false"&gt;
        &lt;domain includeSubdomains="true"&gt;secure.example.com&lt;/domain&gt;
    &lt;/domain-config&gt;
&lt;/network-security-config&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pinning-certificates"><a class="anchor" href="#pinning-certificates"></a>Pinning Certificates</h3>
<div class="paragraph">
<p>Normally, an app trusts all pre-installed CAs. If any of these CAs were to issue a fraudulent certificate, the app would be at risk from a man-in-the-middle attack. Some apps choose to limit the set of certificates they accept by either limiting the set of CAs they trust or by certificate pinning.</p>
</div>
<div class="paragraph">
<p>Certificate pinning is done by providing a set of certificates by hash of the public key (SubjectPublicKeyInfo of the X.509 certificate). A certificate chain is then valid only if the certificate chain contains at least one of the pinned public keys.</p>
</div>
<div class="paragraph">
<p>Note that, when using certificate pinning, you should always include a backup key so that if you are forced to switch to new keys or change CAs (when pinning to a CA certificate or an intermediate of that CA), your app&#8217;s connectivity is unaffected. Otherwise, you must push out an update to the app to restore connectivity.</p>
</div>
<div class="paragraph">
<p><strong>res/xml/network_security_config.xml:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;network-security-config&gt;
    &lt;domain-config&gt;
        &lt;domain includeSubdomains="true"&gt;example.com&lt;/domain&gt;
        &lt;pin-set expiration="2018-01-01"&gt;
            &lt;pin digest="SHA-256"&gt;7HIpactkIAq2Y49orFOOQKurWxmmSFZhBCoQYcRhJ3Y=&lt;/pin&gt;
            &lt;!-- backup pin --&gt;
            &lt;pin digest="SHA-256"&gt;fwza0LRMXouZHRC8Ei+4PyuldPDcf3UKgO/04cDM1oE=&lt;/pin&gt;
        &lt;/pin-set&gt;
    &lt;/domain-config&gt;
&lt;/network-security-config&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-inheritance-behavior"><a class="anchor" href="#configuration-inheritance-behavior"></a>Configuration Inheritance Behavior</h3>
<div class="paragraph">
<p>Values not set in a specific configuration are inherited. This behavior allows more complex configurations while keeping the configuration file readable.</p>
</div>
<div class="paragraph">
<p>If a value is not set in a specific entry, then the value from the more general entry is used. For example, values not set in a domain-config are taken from the parent domain-config, if nested, or from the base-config if not. Values not set in the base-config use the platform default values.</p>
</div>
<div class="paragraph">
<p>For example, consider where all connections to subdomains of example.com must use a custom set of CAs. Additionally, cleartext traffic to these domains is permitted except when connecting to secure.example.com. By nesting the configuration for secure.example.com inside the configuration for example.com, the trust-anchors does not need to be duplicated.</p>
</div>
<div class="sect3">
<h4 id="configuration-file-format"><a class="anchor" href="#configuration-file-format"></a>Configuration File Format</h4>
<div class="paragraph">
<p>The Network Security Configuration feature uses an XML file format. The overall structure of the file is shown in the following code sample:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;network-security-config&gt;
    &lt;base-config&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src="..."/&gt;
            ...
        &lt;/trust-anchors&gt;
    &lt;/base-config&gt;

    &lt;domain-config&gt;
        &lt;domain&gt;android.com&lt;/domain&gt;
        ...
        &lt;trust-anchors&gt;
            &lt;certificates src="..."/&gt;
            ...
        &lt;/trust-anchors&gt;
        &lt;pin-set&gt;
            &lt;pin digest="..."&gt;...&lt;/pin&gt;
            ...
        &lt;/pin-set&gt;
    &lt;/domain-config&gt;
    ...
    &lt;debug-overrides&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src="..."/&gt;
            ...
        &lt;/trust-anchors&gt;
    &lt;/debug-overrides&gt;
&lt;/network-security-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The full network security configuration options can be seen <a href="https://developer.android.com/training/articles/security-config.html#network-security-config">here</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="safetynet"><a class="anchor" href="#safetynet"></a>SafetyNet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SafetyNet provides a set of services and APIs that help protect your app against security threats, including device tampering, bad URLs, potentially harmful apps, and fake users.</p>
</div>
<div class="sect2">
<h3 id="safetynet-attestation-api"><a class="anchor" href="#safetynet-attestation-api"></a>SafetyNet Attestation API</h3>
<div class="paragraph">
<p>The <a href="https://developer.android.com/training/safetynet/attestation.html">SafetyNet Attestation API</a> provides services for determining whether a device running your app satisfies Android compatibility tests.</p>
</div>
<div class="paragraph">
<p>SafetyNet examines software and hardware information on the device where your app is installed to create a profile of that device. The service then attempts to find this same profile within a list of device models that have passed Android compatibility testing. The API also uses this software and hardware information to help you assess the basic integrity of the device, as well as the APK information of the calling app. This attestation helps you to determine whether or not the particular device has been tampered with or otherwise modified.</p>
</div>
</div>
<div class="sect2">
<h3 id="safetynet-safe-browsing-api"><a class="anchor" href="#safetynet-safe-browsing-api"></a>SafetyNet Safe Browsing API</h3>
<div class="paragraph">
<p>The <a href="https://developer.android.com/training/safetynet/safebrowsing.html">SafetyNet Safe Browsing API</a> provides services for determining whether a URL has been marked as a known threat by Google. Your app can use a URL check to determine whether a URL poses a known threat.</p>
</div>
</div>
<div class="sect2">
<h3 id="safetynet-recaptcha-api"><a class="anchor" href="#safetynet-recaptcha-api"></a>SafetyNet reCAPTCHA API</h3>
<div class="paragraph">
<p>The <a href="https://developer.android.com/training/safetynet/recaptcha.html">SafetyNet reCAPTCHA API</a> service includes a reCAPTCHA API that you can use to protect your app from malicious traffic. reCAPTCHA is a free service that uses an advanced risk analysis engine to protect your app from spam and other abusive actions. If the service suspects that the user interacting with your app might be a bot instead of a human, it serves a CAPTCHA that a human must solve before your app can continue executing.</p>
</div>
</div>
<div class="sect2">
<h3 id="safetynet-verify-apps-api"><a class="anchor" href="#safetynet-verify-apps-api"></a>SafetyNet Verify Apps API</h3>
<div class="paragraph">
<p>The <a href="https://developer.android.com/training/safetynet/verify-apps.html">SafetyNet Verify Apps API</a> allows your app to interact programmatically with the Verify Apps feature on a device, protecting the device against potentially harmful apps. The SafetyNet Verify Apps API allows you to leverage this feature to protect your app&#8217;s data. By using this API, you can determine whether a user&#8217;s device is protected by the Verify Apps feature, encourage users not already using the feature to opt in to its protection, and identify any known potentially harmful apps that are installed on the device.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="key-attestation"><a class="anchor" href="#key-attestation"></a>Key Attestation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is a summary of the <a href="https://developer.android.com/training/articles/security-key-attestation.html">Android Developer Key Attestation Security Guide</a> and the <a href="https://www.androidcentral.com/how-android-n-addresses-security">Android 7.0: "Security Benefits that Truly Matter"</a> post.</p>
</div>
<div class="sect2">
<h3 id="verifying-hardware-backed-keypairs"><a class="anchor" href="#verifying-hardware-backed-keypairs"></a>Verifying Hardware Backed Keypairs</h3>
<div class="paragraph">
<p>Key Attestation will allow developers to make sure the keys they may be using in their apps are valid and stored in the phone&#8217;s hardware-backed keystore and not in software. When the attestation tool is given a generated alias for a key (the actual key should never be shared) it then generates a certificate chain that can be used to verify the key. Developers can verify both the key as well as the verified boot state to make sure everything is valid.</p>
</div>
<div class="paragraph">
<p>Phones that ship with Android N and use Google services will have a certificate that&#8217;s issued by Google as the root (or primary) authority while other phones that have been upgraded will need a certificate issued by the company who made them.</p>
</div>
<div class="paragraph">
<p>Not all phones that can run Android N have a trusted hardware environment to store encryption keys, and in those cases, software-level key attestation is used instead. The verified boot state can still be checked to make sure the system software hasn&#8217;t been tampered with.</p>
</div>
</div>
<div class="sect2">
<h3 id="retrieving-and-verifying-a-hardware-backed-key-pair"><a class="anchor" href="#retrieving-and-verifying-a-hardware-backed-key-pair"></a>Retrieving and Verifying a Hardware-backed Key Pair</h3>
<div class="paragraph">
<p>During key attestation, you specify the alias of a key pair. The attestation tool, in return, provides a certificate chain, which you can use to verify the properties of that key pair.</p>
</div>
<div class="paragraph">
<p>If the device supports hardware-level key attestation, the root certificate within this chain is signed using an attestation root key, which the device manufacturer injects into the device&#8217;s hardware-backed keystore at the factory.</p>
</div>
<div class="paragraph">
<p>On devices that ship with hardware-level key attestation, Android 7.0 (API level 24), and Google Play services, the root certificate is signed with the Google attestation root key. You should verify that this root certificate appears within Google&#8217;s list of root certificates.</p>
</div>
</div>
<div class="sect2">
<h3 id="implementing-key-attestation"><a class="anchor" href="#implementing-key-attestation"></a>Implementing Key Attestation</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use a KeyStore object&#8217;s <code>getCertificateChain()</code> method to get a reference to the chain of X.509 certificates associated with the hardware-backed keystore.</p>
</li>
<li>
<p>Check each certificate&#8217;s validity using a X509Certificate object&#8217;s <code>checkValidity()</code> method. <strong>Caution</strong>: Although you can complete this process within your app directly, it&#8217;s safer to check the certificates' revocation lists on a separate server that you trust.</p>
</li>
<li>
<p>On a separate server that you trust, obtain a reference to the ASN.1 parser library that is most appropriate for your toolset. Use this parser to extract the attestation certificate extension data, which appears within the first element of the certificate chain.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The <a href="https://github.com/googlesamples/android-key-attestation">Key Attestation sample</a> uses the ASN.1 parser from Bouncy Castle to extract an attestation certificate&#8217;s extension data. You can use this sample as a reference for creating your own parser.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Compare the extension data that you&#8217;ve retrieved from your ASN.1 parser with the set of values that you expect the hardware-backed key to contain.
<strong>Caution</strong>: Although you can complete this process within your app directly, it&#8217;s safer to check the certificate&#8217;s extension data on a separate server that you trust.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="device-management-policies"><a class="anchor" href="#device-management-policies"></a>Device Management Policies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It allows developers to create an application that manages access to its content by enforcing device management policies.
Specifically, the application can be configured such that it ensures a screen-lock password of sufficient strength is set up before displaying restricted content to the user.</p>
</div>
<div class="sect2">
<h3 id="define-and-declare-policy"><a class="anchor" href="#define-and-declare-policy"></a>Define and Declare policy</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Declare the policy in the <code>res/xml/device_admin.xml</code> file, example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;device-admin xmlns:android="http://schemas.android.com/apk/res/android"&gt;
  &lt;uses-policies&gt;
    &lt;limit-password /&gt;
  &lt;/uses-policies&gt;
&lt;/device-admin&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Then reference it in the Android manifest file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;receiver android:name=".Policy$PolicyAdmin"
    android:permission="android.permission.BIND_DEVICE_ADMIN"&gt;
    &lt;meta-data android:name="android.app.device_admin"
        android:resource="@xml/device_admin" /&gt;
    &lt;intent-filter&gt;
        &lt;action android:name="android.app.action.DEVICE_ADMIN_ENABLED" /&gt;
    &lt;/intent-filter&gt;
&lt;/receiver&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="create-the-device-administration-receiver"><a class="anchor" href="#create-the-device-administration-receiver"></a>Create the Device Administration Receiver</h3>
<div class="paragraph">
<p>The receiver will get notified of events related to the policies you’ve declared to support.
An application can selectively override callback methods. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>public static class PolicyAdmin extends DeviceAdminReceiver {

    @Override
    public void onDisabled(Context context, Intent intent) {
        // Called when the app is about to be deactivated as a device administrator.
        // Deletes previously stored password policy.
        super.onDisabled(context, intent);
        SharedPreferences prefs = context.getSharedPreferences(APP_PREF, Activity.MODE_PRIVATE);
        prefs.edit().clear().commit();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="activate-the-device-administrator"><a class="anchor" href="#activate-the-device-administrator"></a>Activate the Device Administrator</h3>
<div class="paragraph">
<p>Before enforcing any policies, the user needs to manually activate the application as a device administrator.
It can be done like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>if (!mPolicy.isAdminActive()) {

    Intent activateDeviceAdminIntent =
        new Intent(DevicePolicyManager.ACTION_ADD_DEVICE_ADMIN);

    activateDeviceAdminIntent.putExtra(
        DevicePolicyManager.EXTRA_DEVICE_ADMIN,
        mPolicy.getPolicyAdmin());

    // It is good practice to include the optional explanation text to
    // explain to user why the application is requesting to be a device
    // administrator. The system will display this message on the activation
    // screen.
    activateDeviceAdminIntent.putExtra(
        DevicePolicyManager.EXTRA_ADD_EXPLANATION,
        getResources().getString(R.string.device_admin_activation_message));

    startActivityForResult(activateDeviceAdminIntent,
        REQ_ACTIVATE_DEVICE_ADMIN);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implement-the-device-policy-controller"><a class="anchor" href="#implement-the-device-policy-controller"></a>Implement the Device Policy Controller</h3>
<div class="paragraph">
<p>After the device administrator is activated successfully, the application then configures Device Policy Manager with the requested policy.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Require password has minimum uppercase letters</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>DevicePolicyManager mDPM = (DevicePolicyManager)
        context.getSystemService(Context.DEVICE_POLICY_SERVICE);
ComponentName mPolicyAdmin = new ComponentName(context, PolicyAdmin.class);
...
mDPM.setPasswordQuality(mPolicyAdmin, PASSWORD_QUALITY_VALUES[mPasswordQuality]);
mDPM.setPasswordMinimumLength(mPolicyAdmin, mPasswordLength);
if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB) {
    mDPM.setPasswordMinimumUpperCase(mPolicyAdmin, mPasswordMinUpperCase);
}</code></pre>
</div>
</div>
</li>
<li>
<p>If the requirement is not met, invoke the activity to ask user to reset password:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>if (!mDPM.isActivePasswordSufficient()) {
    ...
    // Triggers password change screen in Settings.
    Intent intent =
        new Intent(DevicePolicyManager.ACTION_SET_NEW_PASSWORD);
    startActivity(intent);
}</code></pre>
</div>
</div>
</li>
<li>
<p>Finally, if requirement is met, the app can continue:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>if (!mDPM.isAdminActive(..)) {
    // Activates device administrator.
    ...
} else if (!mDPM.isActivePasswordSufficient()) {
    // Launches password set-up screen in Settings.
    ...
} else {
    // Grants access to secure content.
    ...
    startActivity(new Intent(context, SecureActivity.class));
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="supporting-direct-boot"><a class="anchor" href="#supporting-direct-boot"></a>Supporting Direct Boot</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Android 7.0 runs in a secure, Direct Boot mode when the device has been powered on but the user has not unlocked the device.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Most apps should not use Direct Boot mode, as the apps will be running before user has unlocked the device.
It should only be used if it&#8217;s important for the app to run right after the system is started.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="requesting-access-to-run-during-direct-boot"><a class="anchor" href="#requesting-access-to-run-during-direct-boot"></a>Requesting Access to Run During Direct Boot</h3>
<div class="paragraph">
<p>Apps must register their components with the system before they can run during Direct Boot mode or access device encrypted storage. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;receiver
  android:directBootAware="true" &gt;
  ...
  &lt;intent-filter&gt;
    &lt;action android:name="android.intent.action.LOCKED_BOOT_COMPLETED" /&gt;
  &lt;/intent-filter&gt;
&lt;/receiver&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="accessing-device-encrypted-storage"><a class="anchor" href="#accessing-device-encrypted-storage"></a>Accessing Device Encrypted Storage</h3>
<div class="paragraph">
<p>The app will not be able to access the normal file system as the device is still locked.
Android system provides two new storage locations for data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Credential encrypted storage, which is the default storage location and only available after the user has unlocked the device.</p>
</li>
<li>
<p>Device encrypted storage, which is a storage location available both during Direct Boot mode and after the user has unlocked the device.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can access device encrypted storage like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>Context directBootContext = appContext.createDeviceProtectedStorageContext();
// Access appDataFilename that lives in device encrypted storage
FileInputStream inStream = directBootContext.openFileInput(appDataFilename);
// Use inStream to read content...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="getting-notified-of-user-unlock"><a class="anchor" href="#getting-notified-of-user-unlock"></a>Getting Notified of User Unlock</h3>
<div class="paragraph">
<p>When the user unlocks the device after restart, your app can switch to accessing credential encrypted storage and use regular system services that depend on user credentials.</p>
</div>
<div class="paragraph">
<p>To get notified when the user unlocks the device after a reboot, register a BroadcastReceiver from a running component to listen for unlock notification messages.</p>
</div>
</div>
<div class="sect2">
<h3 id="migrating-existing-data"><a class="anchor" href="#migrating-existing-data"></a>Migrating Existing Data</h3>
<div class="paragraph">
<p>If a user updates their device to use Direct Boot mode, you might have existing data that needs to get migrated to device encrypted storage.</p>
</div>
<div class="paragraph">
<p>You can use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Context.moveSharedPreferencesFrom()</p>
</li>
<li>
<p>Context.moveDatabaseFrom()</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>to migrate preference and database data between credential encrypted storage and device encrypted storage</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-scoped-directory-access"><a class="anchor" href="#using-scoped-directory-access"></a>Using Scoped Directory Access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This function make it easier for apps that just need access to specific directories. For example, photo apps only need to access the <code>Pictures</code> directory.</p>
</div>
<div class="paragraph">
<p>This is a new function provided from Android 7.0</p>
</div>
<div class="sect2">
<h3 id="accessing-an-external-storage-directory"><a class="anchor" href="#accessing-an-external-storage-directory"></a>Accessing an External Storage Directory</h3>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>StorageManager sm = (StorageManager)getSystemService(Context.STORAGE_SERVICE);
StorageVolume volume = sm.getPrimaryStorageVolume();
Intent intent = volume.createAccessIntent(Environment.DIRECTORY_PICTURES);
startActivityForResult(intent, request_code);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The system may confirm the access with the user.</p>
</div>
</div>
<div class="sect2">
<h3 id="accessing-a-directory-on-removable-media"><a class="anchor" href="#accessing-a-directory-on-removable-media"></a>Accessing a Directory on Removable Media</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a BroadcastReceiver that listens for the MEDIA_MOUNTED notification, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;receiver
    android:name=".MediaMountedReceiver"
    android:enabled="true"
    android:exported="true" &gt;
    &lt;intent-filter&gt;
        &lt;action android:name="android.intent.action.MEDIA_MOUNTED" /&gt;
        &lt;data android:scheme="file" /&gt;
    &lt;/intent-filter&gt;
&lt;/receiver&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>When the user mounts removable media, like an SD card, the system sends a MEDIA_MOUNTED notification. Request access like this:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>// BroadcastReceiver has already cached the MEDIA_MOUNTED
// notification Intent in mediaMountedIntent
StorageVolume volume = (StorageVolume)
    mediaMountedIntent.getParcelableExtra(StorageVolume.EXTRA_STORAGE_VOLUME);
volume.createAccessIntent(Environment.DIRECTORY_PICTURES);
startActivityForResult(intent, request_code);</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <div class="container">
    <div class="row">

      <div class="col-sm-4">
        <h5>Mobile Services</h5>
        <ul class="list-unstyled">
         <li><a href="https://aerogear.org/services/identity-management/">Identity Management</a></li>
         <li><a href="https://aerogear.org/services/push/">Push Notifications</a></li>
         <li><a href="https://aerogear.org/services/runtime-connector/">Runtime Connector</a></li>
         <li><a href="https://aerogear.org/services/metrics/">Mobile Metrics</a></li>
         <li><a href="https://aerogear.org/services/mobile-ci-cd/">Mobile CI/CD</a></li>
         <li><a href="https://aerogear.org/services/device-security/">Device Security</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-4">
        <h5>Mobile SDKs</h5>
        <ul class="list-unstyled">
         <li><a href="https://aerogear.org/sdks/android/">Android</a></li>
         <li><a href="https://aerogear.org/sdks/cordova/">Cordova</li>
         <li><a href="https://aerogear.org/sdks/ios/">iOS</a></li>
         <li><a href="https://aerogear.org/sdks/xamarin/">Xamarin</a></li>
        </ul>
      </div><!-- col -->
      
      <div class="col-sm-4">
        <h5>COMMUNITY</h5>
        <ul class="list-unstyled">
          <li><a target="_blank" href="https://github.com/aerogear/">GitHub - Aerogear</a></li>
          <li><a target="_blank" href="https://github.com/aerogearcatalog/">GitHub - Aerogear Catalog</a></li>
          <li><a target="_blank" href="https://issues.jboss.org/browse/AEROGEAR">Jira Repo Issues</a></li>
          <li><a  href="https://aerogear.org/community/contribution-guide/">Contribution Guide</a></li>
          <li><a target="_blank" href="https://groups.google.com/forum/#!forum/aerogear">Google Group</a></li>
          <li><a href="irc://irc.freenode.net/aerogear">IRC</a></li>
        </ul>
      </div><!-- col -->

      <div class="col-sm-12 follow">
        <h5>FOLLOW US</h5>
        <ul class="list-inline">
          <li><a target="_blank" href="https://www.twitter.com/aerogears"><i class="fa fa-twitter-square"></i> Twitter</a></li>
          <li><a target="_blank" href="https://www.youtube.com/channel/UCgDcDoN2b7cEI63fgpxACBA"><i class="fa fa-youtube"></i> YouTube</a></li>
          <li><a target="_blank" href="/feed.atom"><i class="fa fa-rss-square"></i> Feed</a></li>
        </ul>
        
        <p>AeroGear project is licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a></p>
      </div><!-- col -->
    
    </div><!-- row -->

  </div><!-- container -->

</footer><!-- footer -->

<section class="redhat">
  <div class="container">
    <p class="text-center">
      <a href="http://www.redhat.com/">
        <img src="/_/img/redhatlogo-wite.png" alt="redhatlogo-wite" width="130">
      </a>
    </p>       
  </div><!-- container -->
</section>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
