<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untitled :: AeroGear</title>
    <link rel="canonical" href="https://www.aerogear.org/push/latest/ups_userguide/appendix.html">
    <meta name="generator" content="Antora 1.0.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.aerogear.org">AeroGear</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/">Home</a>
        <a class="navbar-item" href="../../processes/latest/index.html">Community Guides</a>        
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Mobile Platform</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="../../android/latest/index.html">Android</a>
            <a class="navbar-item" href="../../ios/latest/index.html">iOS</a>
            <a class="navbar-item" href="../../cordova/latest/index.html">Cordova</a>
            <a class="navbar-item" href="../../xamarin/latest/index.html">Xamarin</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="../../metrics/latest/index.html">Metrics</a>
            <a class="navbar-item" href="../../push/latest/index.html">Push</a>
            <a class="navbar-item" href="../../idm/latest/index.html">Identity</a>       
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="push" data-version="latest">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">AeroGear Push Mobile Service</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Overview</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="overview.html">User&#8217;s Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="server-installation.html">Install the UnifiedPush Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="server-installation_properties.html">System Properties for the UnifiedPush Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="server-installation_advanced.html">Cluster and Docker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="admin-ui.html">Using the Admin UI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ups-debugging.html">Debugging the UnifiedPush Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="integration.html">Integrating the UnifiedPush Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="migration.html">Database migration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="next.html">Next steps</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">AeroGear Push Mobile Service</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">AeroGear</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../aerogear/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear Metrics Mobile Service</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../metrics/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear Processes</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../processes/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">AeroGear Push Mobile Service</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../../../aerogear/latest/index.html" class="home-link"></a>
<nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="../index.html">AeroGear Push Mobile Service</a></li>
    <li class="crumb"><a href="overview.html">User&#8217;s Guide</a></li>
    <li class="crumb"><a href="appendix.html">Appendix</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/aerogearcatalog/unifiedpush-apb/edit/master/docs/modules/ups_userguide/pages/appendix.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<div class="sect1">
<h2 id="appendix"><a class="anchor" href="#appendix"></a>Appendix</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains a few diagrams, that explain the architecutre and the work-flow of the UnifiedPush Server</p>
</div>
<div class="sect2">
<h3 id="global-architecture"><a class="anchor" href="#global-architecture"></a>Global Architecture</h3>
<div class="paragraph">
<p>This diagram show the different components that compose the UnifiedPush Server:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/img/global_architecture.png" alt="Global Architecture"></span></p>
</div>
<div class="paragraph">
<p>The <em>UPS Core</em> contains a DAO layer, talking to the (MySQL/Postgres) database. The DAO layer is invoked by different service classes. The message delivery to the different Push Networks is handled by JMS (see <a href="#_jms_internals">here</a> for more details). The access to the server is handled via two different categories of RESTful APIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="rest-apis"><a class="anchor" href="#rest-apis"></a>REST APIs</h3>
<div class="sect3">
<h4 id="core-apis"><a class="anchor" href="#core-apis"></a>Core APIs</h4>
<div class="paragraph">
<p>The UnifiedPush Server is not limited to be accessed only via the UI for creating PushApplications or Variants. The RESTful <em>Core APIs</em> (e.g. Management/Metric APIs) offer access to the server for integration cases like discussed in the <a href="#integration">UPS Integration</a> section or below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/img/directgrant_app_creation_sd.png" alt="Creating PushApplication from code"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="developer-apis"><a class="anchor" href="#developer-apis"></a>Developer APIs</h4>
<div class="paragraph">
<p>The <em>Developer APIs</em> are more commonly used. They offer public endpoints for device registration and sending Push Notification delivery requests.</p>
</div>
<div class="sect4">
<h5 id="device-registration"><a class="anchor" href="#device-registration"></a>Device Registration</h5>
<div class="paragraph">
<p>Below is a diagram that explain the flow of the <em>Device Registration Process</em>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/img/registration_sd.png" alt="Device Registration"></span></p>
</div>
<div class="paragraph">
<p>When the mobile device obtains a device token (or registrationID) from its PushNetwork (e.g. GCM or APNs), the AeroGear powered application calls our Registration SDK with the given token. The SDK itself authenticates itself against the UnifiedPush Server and sends the token to the server, so that it can be used for future Push Notification sends.</p>
</div>
</div>
<div class="sect4">
<h5 id="sending-a-push-notification"><a class="anchor" href="#sending-a-push-notification"></a>Sending a Push Notification</h5>
<div class="paragraph">
<p>The UnifiedPush Server comes with APIs for <a href="../../../unifiedpush/GetStartedwithJavaSender/">Java</a> and <a href="https://github.com/aerogear/aerogear-unifiedpush-nodejs-client#examples">Node.js</a>. Due to its RESTful architecture any backend, written in any language that supports HTTP(S), can <a href="../../../specs/aerogear-unifiedpush-rest/sender/index.html">send Push Notification requests</a> to it:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/img/sending_sd.png" alt="Sending Push from Backend"></span></p>
</div>
<div class="paragraph">
<p>If the backend needs to send a push notification, e.g. after catching an event, the AeroGear Push Sender SDK is invoked. SDK itself authenticates itself against the UnifiedPush Server and sends the payload to it. This results in several JMS jobs, that are than delivering the payload to the 3rd party Push Networks. Eventually the message may hit the device, delivered from the 3rd party Push Network.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jms-internals"><a class="anchor" href="#jms-internals"></a>JMS internals</h3>
<div class="paragraph">
<p>Currently the delivery of Push Notifications is handled with CDI events and JMS.</p>
</div>
<div class="paragraph">
<p>CDI events are translated into JMS messages so that they can be processed asynchronously and transactionally (if needed).</p>
</div>
<div class="sect3">
<h4 id="token-loading-and-notification-dispatching"><a class="anchor" href="#token-loading-and-notification-dispatching"></a>Token Loading and Notification Dispatching</h4>
<div class="paragraph">
<p>There is architectural diagram describing how different processors works internally:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/img/jms_overview.png" alt="JMS details of the UnifiedPush Server"></span></p>
</div>
<div class="paragraph">
<p>Once the payload hits the RESTful endpoint, a <code>NotificationRouter</code> is invoked, which queues a JMS message into <code>{Network}PushMessageQueue</code>, one for each Variant in the given Application. Once these messages are queued, the REST interface replies 202 Accepted, which indicates that the Push Message was accepted for later processing.</p>
</div>
<div class="paragraph">
<p>Messages from <code>{Network}PushMessageQueue</code> are then processed by <code>TokenLoader</code> transactionally. <code>TokenLoader</code> streams device tokens from database and pushes token batches of configured size (<code>aerogear.{network}.batchSize</code> system property) to <code>{Network}TokenBatchQueue</code>. The <code>TokenLoader</code> loads number of batches to load in one transaction (configurable by <code>aerogear.{network}.batchesToLoad</code> system property). After one token loading transaction, <code>TokenLoader</code> sends a message back to same <code>{Network}PushMessageQueue</code> with information from which token should next transaction continue. The <code>TokenLoader</code> transaction can also fail when memory limits of <code>{Network}TokenBatchQueue</code> are exceeded. In that case, the token loading transaction will be repeated (the batches are de-duplicated by their serial ID, so in that case there will be no duplicate batches).</p>
</div>
<div class="paragraph">
<p>The tokens from <code>{Network}TokenBatchQueue</code> are received by <code>NotificationDispatcher</code> that opens connection/-s to a given Push Network and submits Push Messages for the given batch of tokens. The number of <code>NotificationDispatcher</code> workers can be limited by configuring <code>maxSession</code> activation config properties of Message-Driven Beans.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>maxSession</code> activation config property for MDBs influences how many workers can be instantiated on given node, so this does not limit number of workers in a cluster of nodes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once <code>NotificationDispatches</code> finishes processing for given batch of tokens (no matter if it succeeds or fails), it triggers <code>MetricsCollector</code> that writes metric into database.</p>
</div>
</div>
<div class="sect3">
<h4 id="metric-collection"><a class="anchor" href="#metric-collection"></a>Metric Collection</h4>
<div class="paragraph">
<p>The further details on metric collection process can be seen in the following diagram:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/img/jms_metric_collection.png" alt="JMS details of the Metric Collection"></span></p>
</div>
<div class="paragraph">
<p>Once <code>TokenLoader</code> loads a batch and sends it for processing, it also queues messages to <code>BatchLoadedQueue</code>. Once it loads last token batch, it also queues message to <code>AllBatchesLoadedQueue</code>. These events are important for <code>MetricCollector</code> to decide whether token loading process ended.</p>
</div>
<div class="paragraph">
<p><code>NotificationDispatches</code> sends metrics for each processed message to <code>MetricQueue</code>.</p>
</div>
<div class="paragraph">
<p>Both, <code>TokenLoader</code> and <code>NotificationDispatcher</code> sends message to <code>TriggerVariantMetricQueue</code>. That messages are processed by <code>MetricCollectionTrigger</code> that receives them, deduplicates and sends exactly one message to <code>TriggerMetricCollectionQueue</code>.</p>
</div>
<div class="paragraph">
<p><code>MetricCollector</code> is triggered by message from <code>TriggerMetricCollectionQueue</code>. It receives it transactionally, and if it detects that Push Messaging processing is still in progress, it will roll that transaction back, which means that it will be redelivered (the time after it is redelivered can be configured in JMS queue properties).</p>
</div>
<div class="paragraph">
<p><code>MetricCollector</code> internally collects messages from <code>MetricQueue</code> and <code>BatchLoadedQueue</code>, updates <code>PushMessageInformation</code> object and writes it into database. Once <code>MetricCollector</code> receives message from <code>AllBatchesLoadedQueue</code> and it detects, that metrics were processed for all loaded batches, it ends Push Message metrics collection process by committing its transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="limiting-number-of-apnsservices"><a class="anchor" href="#limiting-number-of-apnsservices"></a>Limiting Number of ApnsServices</h4>
<div class="paragraph">
<p>APNs limits how many connections can be created for one iOS variant. In order to make sure that the number of opened connection won&#8217;t exceed that limit, UnifiedPush Server manages distributed counter of available (free) service slots. The counter is stored as messages in <code>FreeServiceSlotQueue</code>, so each message in that queue represents one available slot for a new service that can be used to open connection to APNs.</p>
</div>
<div class="paragraph">
<p><code>FreeServiceSlotQueue</code> is populated in <code>NotificationRouter</code> with number of messages representing limit of connections that can be created.</p>
</div>
<div class="paragraph">
<p>Once <code>NotificationDispatcher</code> wants to push messages to APNs leveraging <code>ApnsService</code>, it will first ask <code>ApnsServiceHolder</code> for an instance of service. <code>ApnsServiceHolder</code> provides a cached instance or it asks for a slot for a new service instance, then it can create it.</p>
</div>
<div class="paragraph">
<p>When the notifications are dispatched, <code>NotificationDispatches</code> returns instance of <code>ApnsService</code> to <code>ApnsServiceHolder</code> that stores it to a cache for reuse by another dispatcher, and if not reused within time limits, it closes allocated connection and sends a messages to <code>FreeServiceSlotQueue</code> indicating that a new instance can be created.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/img/jms_service_holder.png" alt="JMS details of the ApnsServiceHolder"></span></p>
</div>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
